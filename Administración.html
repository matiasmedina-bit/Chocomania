<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chocomanía · B-05 Stock visible / Agotado</title>
  <meta name="description" content="Administración y visualización de stock: mostrar disponible vs. agotado en el catálogo.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --gap:16px; --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08);
      --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --brand:#7d3c98; --border:#e5e7eb; --accent:#a66cc4;
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      /* altura uniforme de miniaturas (igual que en el Catálogo) */
      --thumb-h: clamp(150px, 22vw, 190px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1140px; margin:0 auto; padding:20px}

    header.top{position:sticky; top:0; z-index:30; backdrop-filter:saturate(180%) blur(8px); background:rgba(246,247,251,.86); border-bottom:1px solid var(--border)}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.15rem}
    .logo{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,#522a7a,#aa6bc8); box-shadow:inset 0 0 0 2px rgba(255,255,255,.25)}
    nav ul{display:flex; gap:14px; list-style:none; margin:0; padding:0}
    nav a{padding:8px 12px; border-radius:999px}
    nav a:hover{background:#ece7f6}
    .btn{border:1px solid var(--border); background:#fff; border-radius:999px; padding:10px 14px; cursor:pointer}
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}

    /* Layout principal: panel admin + catálogo */
    .layout{display:grid; grid-template-columns: 320px 1fr; gap:20px; margin-top:18px}
    @media (max-width: 980px){ .layout{ grid-template-columns:1fr } }

    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
    .muted{color:var(--muted)}

    /* Controles */
    .controls{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:14px}
    .controls .grow{flex:1 1 240px}
    input[type="search"], select, input[type="number"]{padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; background:#fafafa}

    /* Grid productos */
    .grid-products{display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr))}
    .p-card{position:relative; border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; display:flex; flex-direction:column; background:#fff}
    /* Miniatura uniforme (misma que B-04) */
    .p-thumb{
      position:relative;
      width:100%;
      height:var(--thumb-h);
      background:#faf7ff;
      overflow:hidden;
      display:grid; place-items:center;
    }
    .p-thumb img{width:100%; height:100%; object-fit:cover; object-position:center; display:block}
    .badges{position:absolute; top:8px; left:8px; display:flex; gap:6px; pointer-events:none}
    .badge{background:#111827; color:#fff; font-size:.75rem; padding:4px 8px; border-radius:999px}
    .badge.stock{background:#059669}
    .badge.no{background:#9b1c1c}

    /* Cinta AGOTADO + atenuación */
    .ribbon{position:absolute; top:12px; right:-34px; transform:rotate(20deg); background:#f3d0d0; color:#5f1b1b; border:1px dashed #b44; padding:6px 14px; border-radius:8px; font-weight:700; font-size:.8rem; box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .p-card.out .p-thumb::after{content:''; position:absolute; inset:0; background:rgba(255,255,255,.45);}

    .p-body{padding:12px; display:flex; flex-direction:column; gap:8px}
    .p-name{font-weight:600}
    .p-price{display:flex; align-items:baseline; gap:8px}
    .actions{display:flex; gap:8px; align-items:center; margin-top:auto}
    .icon-btn{border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer}
    .btn.small{padding:8px 12px}
    .empty{padding:24px; border:1px dashed #bbb; border-radius:10px; text-align:center; color:#555}

    /* Tabla mini para resumen admin */
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th, td{font-size:.95rem}
    td{background:#fafafa; border:1px solid #e5e7eb; padding:8px 10px}
    td:first-child{border-radius:10px 0 0 10px}
    td:last-child{border-radius:0 10px 10px 0}

    /* Toast */
    .toast-wrap{position:fixed; top:18px; right:18px; display:grid; gap:10px; z-index:50}
    .toast{background:#111827; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); opacity:0; transform:translateY(-10px); transition:.25s}
    .toast.show{opacity:1; transform:translateY(0)}
  </style>
</head>
<body>
  <header class="top">
    <div class="container topbar">
      <div class="brand"><div class="logo" aria-hidden="true"></div> Chocomanía</div>
      <nav aria-label="principal">
        <ul>
          <li><a href="#catalogo">Catálogo</a></li>
          <li><a href="#ofertas">Ofertas</a></li>
          <li><a href="#carrito">Carrito</a></li>
          <li><a href="#ingresar">Ingresar</a></li>
        </ul>
      </nav>
      <button class="btn primary" type="button" id="btnSim2">ADMINISTRADOR</button>
    </div>
  </header>

  <main class="container layout">
    <!-- Panel de administración de stock -->
    <aside class="card" aria-labelledby="t-admin">
      <h2 id="t-admin">Administración de stock</h2>
      <p class="muted">Reglas: <strong>con stock → disponible</strong>; <strong>stock 0 → cinta AGOTADO</strong>.</p>

      <div class="controls" style="margin-top:8px">
        <select id="selProd" class="grow"></select>
      </div>
      <div class="controls">
        <input id="newStock" type="number" min="0" class="grow" placeholder="Nuevo stock">
        <button class="btn small" id="btnGuardar">Guardar</button>
      </div>
      <div class="controls">
        <button class="btn" id="btnAgotar">Marcar Agotado</button>
        <button class="btn" id="btnReponer">Reponer +5</button>
      </div>
      <hr>
      <div class="controls">
        <button class="btn" id="btnSim1">Simular Esc. 1</button>
        <button class="btn" id="btnTodos10">Reponer TODO a 10</button>
      </div>

      <h3 style="margin-top:12px">Resumen rápido</h3>
      <table aria-label="Resumen de stock">
        <thead>
          <tr><th style="text-align:left">Producto</th><th>Stock</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </aside>

    <!-- Catálogo con estado visible/agotado -->
    <section class="card" aria-labelledby="t-cat">
      <h2 id="t-cat">Catálogo</h2>
      <div class="controls">
        <input id="q" class="grow" type="search" placeholder="Buscar producto…" aria-label="Buscar producto">
        <select id="quickCat" aria-label="Categorías">
          <option value="">Todas</option>
          <option>Chocolates</option>
          <option>Bombones</option>
          <option>Trufas</option>
          <option>Brownies</option>
        </select>
        <label style="display:flex; align-items:center; gap:8px"><input id="onlyOut" type="checkbox"> Mostrar solo agotados</label>
      </div>

      <div id="grid" class="grid-products" aria-live="polite"></div>
      <div id="empty" class="empty" style="display:none">No se encontraron productos…</div>
    </section>
  </main>

  <div class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <footer class="container" style="margin:18px auto 24px; color:var(--muted); text-align:center">
    © <span id="year"></span> Chocomanía · Stock visible/agotado
  </footer>

  <script>
    const PRODUCTS = [
      {id:'p01', name:'Chocolate barra',              price:3000, category:'Chocolates', img:'IMG/chocobarra.png'},
      {id:'p02', name:'Bombones surtidos',            price:4500, category:'Bombones',   img:'IMG/BombonesSurt.png'},
      {id:'p03', name:'Trufa de cacao',               price:2500, category:'Trufas',     img:'IMG/Trufasamar.jpg'},
      {id:'p04', name:'Chocolate con almendras',      price:3500, category:'Chocolates', img:'IMG/chocoalmendra.png'},
      {id:'p05', name:'Galletas con chocolate',       price:3000, category:'Chocolates', img:'IMG/gallechoco.png'},
      {id:'p06', name:'Chocolate barra sin azucar',   price:4000, category:'Chocolates', img:'IMG/chocosin.png'},
      {id:'p07', name:'Chocolate caliente',           price:3500, category:'Chocolates', img:'IMG/chococalie.png'},
      {id:'p08', name:'Frutillas con chocolate',      price:3000, category:'Chocolates', img:'IMG/chococonfru.png'},
      {id:'p09', name:'Chocolate amargo 70%',         price:4500, category:'Chocolates', img:'IMG/chocoamar.png'},
      {id:'p10', name:'Brownie chocolate',            price:2500, category:'Brownies',   img:'IMG/brownie.png'},
      {id:'p11', name:'Chocolate Dubai',              price:5000, category:'Chocolates', img:'IMG/ChocoDubai.png'},
      {id:'p12', name:'Trufa clasica',                price:2000, category:'Trufas',     img:'IMG/trufa.png'}
    ];

    const LS_STOCK = 'choco_stock';

    // Estado
    function getStock(){ try{return JSON.parse(localStorage.getItem(LS_STOCK))||{};}catch{return{}} }
    function setStock(map){ localStorage.setItem(LS_STOCK, JSON.stringify(map)); render(); fillTable(); fillSelect(); }

    // Inicializar con valores si no existe (incluye agotados de ejemplo)
    (function seed(){
      const s = getStock();
      if(Object.keys(s).length===0){
        const init = { 
          p01:12, p02:8,  p03:0,  p04:5, 
          p05:6,  p06:9,  p07:10, p08:4, 
          p09:0,  p10:15, p11:5,  p12:7 
        };
        setStock(init);
      }
    })();

    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const q = document.getElementById('q');
    const quickCat = document.getElementById('quickCat');
    const onlyOut = document.getElementById('onlyOut');

    const toastWrap = document.querySelector('.toast-wrap');
    function toast(msg, type='ok'){
      const t = document.createElement('div'); t.className='toast'; t.textContent=msg;
      if(type==='err'){ t.style.background='#991b1b'; }
      if(type==='warn'){ t.style.background='#92400e'; }
      if(type==='ok'){ t.style.background='#065f46'; }
      toastWrap.appendChild(t);
      requestAnimationFrame(()=> t.classList.add('show'));
      setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(), 200); }, 2600);
    }

    function currency(n){ return n.toLocaleString('es-CL', {style:'currency', currency:'CLP', maximumFractionDigits:0}); }

    function applyFilters(){
      const text = q.value.trim().toLowerCase();
      const cat = quickCat.value;
      const st = getStock();
      let arr = PRODUCTS.filter(p=> (
        (!text || p.name.toLowerCase().includes(text)) &&
        (!cat || p.category===cat)
      ));
      if(onlyOut.checked){ arr = arr.filter(p=> (st[p.id]||0)===0); }
      return arr;
    }

    function render(){
      grid.innerHTML='';
      const list = applyFilters();
      const st = getStock();
      if(list.length===0){ empty.style.display='block'; return; }
      empty.style.display='none';

      list.forEach(p=>{
        const s = st[p.id]||0;
        const card = document.createElement('article'); 
        card.className='p-card' + (s<=0 ? ' out' : '');
        const thumb = document.createElement('div'); thumb.className='p-thumb';
        if(p.img){ const img = document.createElement('img'); img.alt = p.name; img.src = p.img; thumb.appendChild(img); }
        else { thumb.innerHTML = '<span style="color:#8f6aa6;font-weight:600">Sin imagen</span>'; }

        const badges = document.createElement('div'); badges.className='badges';
        const bStock = document.createElement('span'); bStock.className = 'badge ' + (s>0?'stock':'no'); bStock.textContent = s>0? `Stock: ${s}` : 'Sin stock';
        badges.appendChild(bStock); thumb.appendChild(badges);

        if(s<=0){
          const r = document.createElement('div'); r.className='ribbon'; r.textContent='AGOTADO'; thumb.appendChild(r);
        }

        const body = document.createElement('div'); body.className='p-body';
        const name = document.createElement('div'); name.className='p-name'; name.textContent=p.name;
        const price = document.createElement('div'); price.className='p-price';
        const cur = document.createElement('strong'); cur.textContent = currency(p.price); price.appendChild(cur);

        const actions = document.createElement('div'); actions.className='actions';
        const add = document.createElement('button'); add.className='btn small'; add.type='button'; add.textContent = s>0? 'Agregar' : 'Sin stock';
        add.disabled = s<=0; add.title = s>0? 'Agregar al carrito' : 'Producto agotado';
        actions.appendChild(add);

        body.append(name, price, actions);
        card.append(thumb, body);
        grid.appendChild(card);
      });
    }

    // --- Panel Admin ---
    const selProd = document.getElementById('selProd');
    const newStock = document.getElementById('newStock');
    const tbody = document.getElementById('tbody');

    function fillSelect(){
      const cur = selProd.value;
      selProd.innerHTML='';
      PRODUCTS.forEach(p=>{
        const o = document.createElement('option'); o.value=p.id; o.textContent=p.name; selProd.appendChild(o);
      });
      if(cur){ selProd.value = cur; }
    }

    function fillTable(){
      const st = getStock();
      tbody.innerHTML='';
      PRODUCTS.forEach(p=>{
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = p.name;
        const td2 = document.createElement('td'); td2.style.textAlign='center'; td2.textContent = st[p.id]||0;
        tr.append(td1, td2); tbody.appendChild(tr);
      });
    }

    document.getElementById('btnGuardar').addEventListener('click', ()=>{
      const id = selProd.value; const val = parseInt(newStock.value,10);
      if(isNaN(val) || val<0){ toast('Ingresa un stock válido.', 'warn'); return; }
      const st = getStock(); st[id] = val; setStock(st); toast('Stock actualizado.','ok'); newStock.value='';
    });
    document.getElementById('btnAgotar').addEventListener('click', ()=>{
      const st = getStock(); st[selProd.value] = 0; setStock(st); toast('Producto marcado como AGOTADO.','warn');
    });
    document.getElementById('btnReponer').addEventListener('click', ()=>{
      const st = getStock(); st[selProd.value] = (st[selProd.value]||0) + 5; setStock(st); toast('Producto repuesto (+5).','ok');
    });

    document.getElementById('btnTodos10').addEventListener('click', ()=>{
      const st = getStock(); PRODUCTS.forEach(p=> st[p.id]=10); setStock(st); toast('Todos a 10 unidades.','ok');
    });

    // Escenarios de tu wireframe
    document.getElementById('btnSim1').addEventListener('click', ()=>{
      const st = { p01:5, p02:4, p03:3, p04:6, p05:2, p06:8, p07:12, p08:5, p09:4, p10:9, p11:7, p12:6 };
      setStock(st); toast('Escenario 1: con stock → disponibles.','ok');
    });
    document.getElementById('btnSim2').addEventListener('click', ()=>{
      const st = getStock(); st.p03=0; st.p09=0; st.p06=0; st.p11=0; setStock(st); toast('Escenario 2: varios productos AGOTADOS.','warn');
    });

    // Filtros catálogo
    function refresh(){ render(); }
    q.addEventListener('input', refresh);
    quickCat.addEventListener('change', refresh);
    onlyOut.addEventListener('change', refresh);

    // Init
    fillSelect(); fillTable(); render();
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
