<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chocomanía · B-11 Anulación de pedidos</title>
  <meta name="description" content="Flujo de anulación por cliente y por administrador, ventanas de tiempo, estados no anulables y bitácora de auditoría.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --gap:16px; --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08);
      --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --brand:#7d3c98; --border:#e5e7eb;
      --ok:#0d7a55; --warn:#92400e; --err:#991b1b; --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1140px; margin:0 auto; padding:20px}

    header.top{position:sticky; top:0; z-index:30; backdrop-filter:saturate(180%) blur(8px); background:rgba(246,247,251,.86); border-bottom:1px solid var(--border)}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.15rem}
    .logo{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,#522a7a,#aa6bc8); box-shadow:inset 0 0 0 2px rgba(255,255,255,.25)}
    nav ul{display:flex; gap:14px; list-style:none; margin:0; padding:0}
    nav a{padding:8px 12px; border-radius:999px}
    nav a:hover{background:#ece7f6}
    .btn{border:1px solid var(--border); background:#fff; border-radius:999px; padding:10px 14px; cursor:pointer}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn.danger{background:#ffecec; border-color:#e5b3b3}
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
    .btn.small{padding:8px 12px}

    .section{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); margin-bottom:18px}
    .card{border:1px dashed #cfcfcf; border-radius:12px; padding:16px; background:#fafafa}
    .title{font-weight:800; margin-bottom:8px}
    .muted{color:var(--muted)}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:var(--chip); font-size:.85rem; font-weight:600}

    .modal{width:min(520px, 92vw); margin:12px auto; padding:16px; border:2px dashed #bdbdbd; border-radius:12px; background:#fff; display:flex; flex-direction:column; gap:12px; align-items:center; text-align:center}

    .form{display:flex; flex-direction:column; gap:10px; width:100%}
    .form label{display:flex; flex-direction:column; gap:6px; font-weight:600; text-align:left}
    .form select, .form textarea{padding:10px 12px; border:1px solid #ccc; border-radius:8px; background:#fafafa}
    .row-actions{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}

    .ok{color:var(--ok)}
    .warn{color:var(--err)}
    .grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px}

    /* Toast */
    .toast-wrap{position:fixed; top:18px; right:18px; display:grid; gap:10px; z-index:50}
    .toast{background:#111827; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); opacity:0; transform:translateY(-10px); transition:.25s}
    .toast.show{opacity:1; transform:translateY(0)}

    /* Table */
    table{width:100%; border-collapse:separate; border-spacing:0 6px}
    th, td{padding:8px 10px; border:1px solid #e5e7eb; background:#fff; vertical-align:top}
    th{background:#f3f4f6; text-align:left}
    td:first-child, th:first-child{border-radius:10px 0 0 10px}
    td:last-child, th:last-child{border-radius:0 10px 10px 0}
    tr[data-clickable="true"]{cursor:pointer}
    tr[data-clickable="true"]:hover td{background:#f9fafb}
    .mini{font-size:.85rem}
    .badge{padding:2px 8px; border-radius:999px; font-weight:700; font-size:.75rem; display:inline-block}
    .b-prep{background:#fff7ed; color:#9a3412}
    .b-rec{background:#eef2ff; color:#3730a3}
    .b-desp{background:#eff6ff; color:#1d4ed8}
    .b-rep{background:#ecfeff; color:#0e7490}
    .b-ent{background:#ecfdf5; color:#047857}
    .b-canc{background:#fee2e2; color:#991b1b}
  </style>
</head>
<body>
  <header class="top">
    <div class="container topbar">
      <div class="brand"><div class="logo" aria-hidden="true"></div> Chocomanía</div>
      <nav aria-label="principal">
        <ul>
          <li><a href="#historial">Historial</a></li>
          <li><a href="#esc1">Cliente</a></li>
          <li><a href="#esc2">Admin</a></li>
          <li><a href="#esc3">No anulable</a></li>
        </ul>
      </nav>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn small" id="seedData" type="button">Sembrar pedidos demo</button>
        <button class="btn small" id="resetData" type="button">Reiniciar demo</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Historial/Auditoría -->
    <section id="historial" class="section" aria-labelledby="historial-title">
      <h2 id="historial-title">Pedidos y auditoría</h2>
      <div class="grid">
        <div class="card">
          <div class="title">Pedidos</div>
          <p class="mini muted">Haz clic en un pedido para cargarlo en los escenarios.</p>
          <table aria-label="Pedidos">
            <thead><tr><th>N°</th><th>Estado</th><th>Fecha</th><th>Total</th><th>Resumen</th></tr></thead>
            <tbody id="ordersTbody"></tbody>
          </table>
        </div>
        <div class="card">
          <div class="title">Bitácora de anulaciones</div>
          <table aria-label="Bitácora">
            <thead><tr><th>Pedido</th><th>Quién</th><th>Motivo</th><th>Detalle</th><th>Fecha</th></tr></thead>
            <tbody id="logTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Escenario 1: Cliente -->
    <section class="section" aria-labelledby="esc1">
      <h2 id="esc1">Anulación por el cliente (preparando)</h2>
      <div class="card">
        <div class="title">Pedido Realizado</div>
        <p>
          Tu orden <strong id="e1Order">—</strong>
          <span class="chip"><span aria-hidden="true">⏱</span>
            <span id="e1StatusTxt">—</span>
          </span>
          <span class="muted" id="e1Elapsed"></span>
        </p>
        <div id="e1WindowInfo" class="mini muted" aria-live="polite"></div>
        <div class="modal">
          <form class="form" id="clientForm" action="#" method="post">
            <label>Motivo de anulación
              <select id="clientReason">
                <option value="Cambio de decisión">Cambio de decisión</option>
                <option value="Error en productos">Error en productos</option>
                <option value="Dirección incorrecta">Dirección incorrecta</option>
                <option value="Otro">Otro…</option>
              </select>
            </label>
            <label>Detalle (opcional)
              <textarea id="clientDetail" rows="3" placeholder="Escribe un detalle breve…"></textarea>
            </label>
            <div class="row-actions">
              <button class="btn danger" id="btnClientCancel" type="button">Anular compra</button>
              <button class="btn" type="reset">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
      <div class="modal" id="clientConfirm" style="display:none">
        <strong class="ok">Confirmar Anulación</strong>
        <p>Tu pedido ha sido cancelado.</p>
        <button class="btn primary" id="clientAccept" type="button">Aceptar anulación</button>
      </div>
    </section>

    <!-- Escenario 2: Admin -->
    <section class="section" aria-labelledby="esc2">
      <h2 id="esc2">Anulación por administrador (pedido “recibido”)</h2>
      <div class="modal">
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
          <label>Admin:
            <select id="adminUser" style="padding:8px 10px; border:1px solid #ccc; border-radius:8px">
              <option>carla@choco.cl</option>
              <option>maria@choco.cl</option>
              <option>andres@choco.cl</option>
            </select>
          </label>
          <label>Motivo:
            <select id="adminReason" style="padding:8px 10px; border:1px solid #ccc; border-radius:8px">
              <option>Stock no disponible</option>
              <option>Pago no conciliado</option>
              <option>Solicitud por cliente (fuera de ventana)</option>
            </select>
          </label>
        </div>
        <p>Orden <strong id="e2Order">—</strong> será cancelada por <em id="e2Why">—</em>. Se registrará usuario y fecha para auditoría.</p>
        <div class="row-actions">
          <button class="btn danger" id="btnAdminCancel" type="button">Cancelar como administrador</button>
          <button class="btn" type="button" id="btnAdminClose">Aceptar</button>
        </div>
      </div>
    </section>

    <!-- Escenario 3: No anulable -->
    <section class="section" aria-labelledby="esc3">
      <h2 id="esc3">Pedido no anulable por estado</h2>
      <div class="modal">
        <p>Pedido <strong id="e3Order">—</strong> en estado <strong id="e3Status">—</strong>.</p>
        <p class="warn"><strong>No es posible anular en este estado.</strong></p>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center">
          <button class="btn small" id="e3Try" type="button">Intentar anular</button>
          <label>Simular estado:
            <select id="e3State" style="padding:8px 10px; border:1px solid #ccc; border-radius:8px">
              <option value="despachado">despachado</option>
              <option value="reparto">reparto</option>
              <option value="entregado">entregado</option>
              <option value="preparando">preparando</option>
              <option value="recibido">recibido</option>
            </select>
          </label>
        </div>
      </div>
    </section>
  </main>

  <div class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <footer class="container" style="margin:18px auto 24px; color:var(--muted); text-align:center">© <span id="year"></span> Chocomanía · Anulación de pedidos</footer>

  <script>
    // ===== Utilidades =====
    const $ = (s)=> document.querySelector(s);
    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.querySelector('.toast-wrap').appendChild(t); requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),200); }, 2200); }
    function currency(n){ return n.toLocaleString('es-CL', {style:'currency', currency:'CLP', maximumFractionDigits:0}); }
    function minutesSince(dateStr){ const d=new Date(dateStr.replace(' ', 'T')); return Math.floor((Date.now()-d.getTime())/60000); }
    function nowISO(){ const d=new Date(); const p=(n)=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }
    function isoFrom(ms){ const d=new Date(ms); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}` }
    function badge(st){ const map={preparando:'b-prep', recibido:'b-rec', despachado:'b-desp', reparto:'b-rep', entregado:'b-ent', cancelado:'b-canc'}; return `<span class="badge ${map[st]||''}">${st}</span>` }
    function summarizeItems(items){
      if(!items || items.length===0) return '—';
      return items.map(it => {
        if(typeof it === 'string') return it;
        const n = (it.qty ?? it.cant ?? 1);
        const name = it.name ?? it.title ?? 'ítem';
        return `${n}x ${name}`;
      }).join(', ');
    }

    // ===== Storage =====
    const LS_ORDERS='choco_orders', LS_LOG='choco_cancel_log', LS_ACTIVE='choco_active_order';
    const CANCEL_WINDOW_MIN=30;
    const NON_CANCELLABLE = ['despachado','reparto','entregado'];

    const getOrders = ()=> JSON.parse(localStorage.getItem(LS_ORDERS)||'[]');
    const setOrders = (arr)=> localStorage.setItem(LS_ORDERS, JSON.stringify(arr));
    const getActiveId = ()=> new URLSearchParams(location.search).get('order') || localStorage.getItem(LS_ACTIVE) || 'ORD-2025-048';
    const setActiveId = (id)=>{ localStorage.setItem(LS_ACTIVE,id); history.replaceState(null,'',`?order=${id}`); loadAll(); };
    function logCancel(entry){ const arr=JSON.parse(localStorage.getItem(LS_LOG)||'[]'); arr.unshift(entry); localStorage.setItem(LS_LOG, JSON.stringify(arr)); renderLog(); }

    function seedDemo(overwrite=false){
      let arr=getOrders();
      if(overwrite || arr.length===0){
        const base = Date.now();
        arr = [
          { id:'ORD-2025-048', date: isoFrom(base-15*60*1000), status:'cancelado', total:9500, items:[{qty:1,name:'Brownie cacao'},{qty:1,name:'Galletas chips'}], cancelBy:'carla@choco.cl', cancelReason:'Stock no disponible', cancelledAt: isoFrom(base-13*60*1000) },
          { id:'ORD-2025-047', date: isoFrom(base-60*60*1000), status:'recibido',   total:18990, items:[{qty:1,name:'Caja trufas 12u'},{qty:2,name:'Tableta 70%'}] },
          { id:'ORD-2025-046', date: isoFrom(base-2*60*60*1000), status:'preparando', total:12990, items:['Bombones surtidos 9u','Chocolate caliente 1L'] },
          { id:'ORD-2025-045', date: isoFrom(base-3*60*60*1000), status:'despachado', total:7990,  items:['Pack galletas 6u'] }
        ];
        setOrders(arr);
        localStorage.setItem(LS_ACTIVE, 'ORD-2025-048');
        // Bitácora base para 048
        localStorage.setItem(LS_LOG, JSON.stringify([
          { id:'ORD-2025-048', by:'carla@choco.cl', reason:'Stock no disponible', detail:'—', date: isoFrom(base-13*60*1000) }
        ]));
      }
    }

    // ===== Render =====
    function renderOrders(){
      const tbody=$('#ordersTbody'); tbody.innerHTML='';
      getOrders().forEach(o=>{
        const tr=document.createElement('tr'); tr.dataset.clickable="true";
        tr.innerHTML=`
          <td>${o.id}</td>
          <td>${badge(o.status)}</td>
          <td>${o.date}</td>
          <td>${currency(o.total||0)}</td>
          <td class="mini muted">${summarizeItems(o.items)}</td>`;
        tr.addEventListener('click', ()=>{ setActiveId(o.id); toast('Cargado '+o.id); });
        if(o.id===getActiveId()) tr.style.outline='2px solid #c7a6ea';
        tbody.appendChild(tr);
      });
    }
    function renderLog(){
      const tbody=$('#logTbody'); tbody.innerHTML='';
      const arr=JSON.parse(localStorage.getItem(LS_LOG)||'[]');
      if(arr.length===0){ tbody.innerHTML='<tr><td colspan="5" class="muted">Aún no hay registros.</td></tr>'; return; }
      arr.forEach(l=>{
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${l.id}</td><td>${l.by}</td><td>${l.reason}</td><td>${l.detail||''}</td><td>${l.date}</td>`; tbody.appendChild(tr);
      });
    }

    // ===== Escenario 1: Cliente =====
    let e1Timer=null;
    function loadE1(){
      const o=getOrders().find(x=>x.id===getActiveId()); if(!o) return;
      $('#e1Order').textContent=o.id;
      $('#e1StatusTxt').innerHTML = `estado: <strong>${o.status}</strong>`;
      $('#e1Elapsed').textContent = `· ${minutesSince(o.date)} min desde la compra`;
      updateClientWindow(o);
    }
    function updateClientWindow(o){
      clearInterval(e1Timer);
      const info = $('#e1WindowInfo');
      const btn  = $('#btnClientCancel');
      function tick(){
        if(o.status!=='preparando'){
          info.textContent = 'La anulación por cliente solo aplica con estado “preparando”.';
          btn.disabled = true; return;
        }
        const left = Math.max(0, CANCEL_WINDOW_MIN - minutesSince(o.date));
        if(left===0){ info.textContent='Ventana de anulación expirada.'; btn.disabled=true; }
        else { info.textContent=`Tiempo restante de ventana: ${left} min.`; btn.disabled=false; }
      }
      tick();
      e1Timer=setInterval(tick, 60000);
    }
    function clientCancel(){
      const arr=getOrders(); const i=arr.findIndex(x=>x.id===getActiveId()); if(i<0){ toast('Pedido no encontrado'); return; }
      const o=arr[i];
      if(o.status!=='preparando') return toast('Solo aplica en “preparando”.');
      if(minutesSince(o.date)>CANCEL_WINDOW_MIN) return toast('Ventana expirada.');
      $('#clientConfirm').style.display='flex';
    }
    $('#clientAccept').addEventListener('click', ()=>{
      const arr=getOrders(); const i=arr.findIndex(x=>x.id===getActiveId()); if(i<0) return;
      const reason=$('#clientReason').value; const detail=$('#clientDetail').value.trim();
      arr[i].status='cancelado'; arr[i].cancelledAt=nowISO(); arr[i].cancelBy='cliente'; arr[i].cancelReason=reason; arr[i].cancelDetail=detail;
      setOrders(arr); renderOrders(); loadE1();
      logCancel({ id:arr[i].id, by:'cliente', reason, detail, date:arr[i].cancelledAt });
      toast('Pedido cancelado por el cliente');
      $('#clientConfirm').style.display='none';
    });

    // ===== Escenario 2: Admin =====
    function loadE2(){
      $('#e2Order').textContent=getActiveId();
      $('#e2Why').textContent=$('#adminReason').value;
    }
    $('#adminReason').addEventListener('change', loadE2);
    function adminCancel(){
      const arr=getOrders(); const i=arr.findIndex(x=>x.id===getActiveId()); if(i<0){ toast('Pedido no encontrado'); return; }
      const o=arr[i];
      if(o.status==='cancelado') return toast('Este pedido ya está cancelado');
      if(o.status==='preparando') o.status='recibido'; // ya no aplica ventana cliente
      const user=$('#adminUser').value; const reason=$('#adminReason').value; const when=nowISO();
      o.status='cancelado'; o.cancelledAt=when; o.cancelBy=user; o.cancelReason=reason; o.cancelDetail='—';
      setOrders(arr); renderOrders(); loadE1(); loadE3();
      logCancel({ id:o.id, by:user, reason, detail:'—', date:when });
      toast('Pedido cancelado por admin');
    }

    // ===== Escenario 3: No anulable =====
    function loadE3(){
      const o=getOrders().find(x=>x.id===getActiveId()); if(!o) return;
      $('#e3Order').textContent=o.id; $('#e3Status').textContent=o.status;
    }
    function tryE3(){
      const st=$('#e3State').value; $('#e3Status').textContent=st;
      toast(NON_CANCELLABLE.includes(st) ? 'No es posible anular en estado '+st : 'Este estado sí permite anulación: '+st);
    }

    // ===== Eventos de UI =====
    $('#seedData').addEventListener('click', ()=>{ seedDemo(false); toast('Pedidos demo listos'); loadAll(); });
    $('#resetData').addEventListener('click', ()=>{ seedDemo(true); toast('Demo reiniciada'); loadAll(); });
    $('#btnClientCancel').addEventListener('click', clientCancel);
    $('#btnAdminCancel').addEventListener('click', adminCancel);
    $('#btnAdminClose').addEventListener('click', ()=> toast('OK'));
    $('#e3Try').addEventListener('click', tryE3);

    function loadAll(){ renderOrders(); renderLog(); loadE1(); loadE2(); loadE3(); }
    // Init
    seedDemo(false); loadAll();
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
