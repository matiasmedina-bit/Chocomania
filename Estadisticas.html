<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chocomanía · B‑16 Estadísticas</title>
  <meta name="description" content="Reportes mensuales con enlace a estadísticas: ranking de productos y clientes frecuentes por mes, con integración a datos locales si existen.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --gap:16px; --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08); --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --brand:#7d3c98; --border:#e5e7eb; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1140px; margin:0 auto; padding:20px}

    header.top{position:sticky; top:0; z-index:30; backdrop-filter:saturate(180%) blur(8px); background:rgba(246,247,251,.86); border-bottom:1px solid var(--border)}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.15rem}
    .logo{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,#522a7a,#aa6bc8); box-shadow:inset 0 0 0 2px rgba(255,255,255,.25)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .btn{border:1px solid var(--border); background:#fff; border-radius:999px; padding:8px 14px; cursor:pointer}
    .btn.small{padding:6px 10px}

    .section{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); margin-bottom:18px}

    .report{display:grid; grid-template-columns: 260px 1fr; gap:var(--gap)}
    @media (max-width: 920px){ .report{ grid-template-columns: 1fr; } }

    .picker{border:1px dashed #ddd; border-radius:10px; padding:12px; background:#fff}
    .month-list{list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px}
    .month-list li{display:flex; align-items:center; gap:8px}
    .summary{border:1px dashed #ddd; border-radius:10px; padding:16px; background:#fff; display:flex; flex-direction:column; gap:10px; justify-content:center; min-height:140px}
    .kpi{font-size:1.15rem}
    .kpi b{font-size:1.25rem}
    a.btnlink{display:inline-block; margin-top:6px; padding:8px 12px; border:1px solid #666; border-radius:999px; background:#eee; text-decoration:none; color:inherit}

    .stats{display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); border:1px dashed #ddd; border-radius:10px; padding:16px; background:#fff}
    .box{border:1px dashed #cfcfcf; border-radius:10px; padding:12px; background:#fafafa}
    .box h4{margin-top:0}
    ol{margin:0; padding-left:18px}
    .muted{color:var(--muted)}

    /* Toast */
    .toast-wrap{position:fixed; top:18px; right:18px; display:grid; gap:10px; z-index:50}
    .toast{background:#111827; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); opacity:0; transform:translateY(-10px); transition:.25s}
    .toast.show{opacity:1; transform:translateY(0)}
  </style>
</head>
<body>
  <header class="top">
    <div class="container topbar">
      <div class="brand"><div class="logo" aria-hidden="true"></div> Chocomanía</div>
      <div class="row">
        <button class="btn small" id="seedBtn" type="button">Sembrar demo</button>
        <button class="btn small" id="clearBtn" type="button">Limpiar datos</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- ===== Escenario 1: Enero 2025 con enlace a estadísticas ===== -->
    <section class="section" aria-labelledby="esc1">
      <h2 id="esc1">Reportes mensuales — Enero 2025</h2>
      <div class="report">
        <aside class="picker">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <label for="m1"><b>Fecha</b></label>
          </div>
          <ul class="month-list" id="m1">
            <li><label><input type="checkbox" disabled /> Noviembre/2024</label></li>
            <li><label><input type="checkbox" disabled /> Diciembre/2024</label></li>
            <li><label><input type="checkbox" data-ym="2025-01" checked /> <b>Enero/2025</b></label></li>
            <li><label><input type="checkbox" disabled /> Febrero/2025</label></li>
          </ul>
        </aside>
        <section class="summary" id="sum-2025-01">
          <div class="kpi"><b>Pedidos Totales:</b> <span data-kpi="orders">227</span></div>
          <div class="kpi"><b>Ingresos:</b> <span data-kpi="revenue">$1.254.728</span></div>
          <a class="btnlink" href="#stats-ene">Estadísticas</a>
        </section>
      </div>
    </section>

    <!-- Panel de estadísticas Enero 2025 -->
    <section id="stats-ene" class="section" aria-labelledby="esc1-stats">
      <h2 id="esc1-stats">Estadísticas — Enero 2025</h2>
      <div class="stats">
        <div class="box">
          <h4>Productos (Top 5)</h4>
          <ol id="prod-2025-01">
            <li>Chocolate Dubai</li>
            <li>Bombones Surtidos</li>
            <li>Frutillas con chocolate</li>
            <li>Chocolate Amargo 70%</li>
            <li>Chocolate Caliente</li>
          </ol>
        </div>
        <div class="box">
          <h4>Vendidos</h4>
          <ol class="muted" id="qty-2025-01">
            <li>72 pedidos</li>
            <li>64 pedidos</li>
            <li>47 pedidos</li>
            <li>29 pedidos</li>
            <li>14 pedidos</li>
          </ol>
        </div>
      </div>
    </section>

    <!-- ===== Escenario 2: Febrero 2025 ===== -->
    <section class="section" aria-labelledby="esc2">
      <h2 id="esc2">Reportes mensuales — Febrero 2025</h2>
      <div class="report">
        <aside class="picker">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <label for="m2"><b>Fecha</b></label>
          </div>
          <ul class="month-list" id="m2">
            <li><label><input type="checkbox" disabled /> Diciembre/2024</label></li>
            <li><label><input type="checkbox" disabled /> Enero/2025</label></li>
            <li><label><input type="checkbox" data-ym="2025-02" checked /> <b>Febrero/2025</b></label></li>
            <li><label><input type="checkbox" disabled /> Marzo/2025</label></li>
          </ul>
        </aside>
        <section class="summary" id="sum-2025-02">
          <div class="kpi"><b>Pedidos Totales:</b> <span data-kpi="orders">328</span></div>
          <div class="kpi"><b>Ingresos:</b> <span data-kpi="revenue">$1.972.694</span></div>
          <a class="btnlink" href="#stats-feb">Estadísticas</a>
        </section>
      </div>
    </section>

    <!-- Panel de estadísticas Febrero 2025 -->
    <section id="stats-feb" class="section" aria-labelledby="esc2-stats">
      <h2 id="esc2-stats">Estadísticas — Febrero 2025</h2>
      <div class="stats">
        <div class="box">
          <h4>Productos (Top 5)</h4>
          <ol id="prod-2025-02">
            <li>Trufa Avellana</li>
            <li>Bombón Amargo</li>
            <li>—</li>
            <li>—</li>
            <li>—</li>
          </ol>
        </div>
        <div class="box">
          <h4>Clientes frecuentes (Top 5)</h4>
          <ol class="muted" id="cli-2025-02">
            <li>ana@example.com</li>
            <li>pedro@example.com</li>
            <li>—</li>
            <li>—</li>
            <li>—</li>
          </ol>
        </div>
      </div>
    </section>
  </main>

  <div class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <footer class="container" style="margin:18px auto 24px; color:var(--muted); text-align:center">© <span id="year"></span> Chocomanía · Estadísticas</footer>

  <script>
    // ===== Utilidades =====
    const $ = (s)=> document.querySelector(s);
    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.querySelector('.toast-wrap').appendChild(t); requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),200); }, 2200); }
    function currency(n){ return n.toLocaleString('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}); }

    // ===== Storage Keys =====
    const LS_REPORTS='choco_reports'; // de la Parte 15
    const LS_STATS='choco_stats';     // { '2025-01': {products:[{name,qty}], clients:[{email,qty}]}, ... }
    const LS_ORDERS='choco_orders';   // opcional: orders con items para agregar

    // ===== Datos demo para esta parte =====
    function seedDemo(){
      const reports=[
        {ym:'2025-01', orders:227, revenue:1254728},
        {ym:'2025-02', orders:328, revenue:1972694}
      ];
      localStorage.setItem(LS_REPORTS, JSON.stringify(reports));
      const stats={
        '2025-01': { products:[
          {name:'Chocolate Dubai', qty:72},
          {name:'Bombones Surtidos', qty:64},
          {name:'Frutillas con chocolate', qty:47},
          {name:'Chocolate Amargo 70%', qty:29},
          {name:'Chocolate Caliente', qty:14}
        ], clients:[] },
        '2025-02': { products:[
          {name:'Trufa Avellana', qty:81},
          {name:'Bombón Amargo', qty:62},
          {name:'Chocolate con Almendras', qty:44},
          {name:'Trufa de Cacao', qty:31},
          {name:'Chocolate Blanco', qty:19}
        ], clients:[
          {email:'ana@example.com', qty:9},
          {email:'pedro@example.com', qty:7},
          {email:'luis@example.com', qty:5},
          {email:'marta@example.com', qty:4},
          {email:'lucia@example.com', qty:4}
        ] }
      };
      localStorage.setItem(LS_STATS, JSON.stringify(stats));
      renderAll(); toast('Demo sembrada');
    }

    function loadReports(){ try{return JSON.parse(localStorage.getItem(LS_REPORTS))||[]}catch{return[]} }
    function loadStats(){ try{return JSON.parse(localStorage.getItem(LS_STATS))||{}}catch{return{}} }

    // ===== Agregación opcional desde choco_orders =====
    function aggregateFromOrders(ym){
      try{
        const arr=JSON.parse(localStorage.getItem(LS_ORDERS)||'[]');
        if(!arr.length) return null;
        const [y,m]=ym.split('-').map(Number);
        const sameMonth=(d)=>{ const dt=new Date((d||'').replace(' ','T')); return dt.getFullYear()===y && (dt.getMonth()+1)===m; };
        const prodMap=new Map(); const cliMap=new Map(); let orders=0, revenue=0;
        arr.forEach(o=>{
          if(!sameMonth(o.date)) return;
          orders++;
          revenue += (o.total||0);
          const lines = o.items || o.lines || [];
          lines.forEach(l=>{
            const name = l.name || l.product || 'Producto';
            const qty = Number(l.qty||l.quantity||1);
            prodMap.set(name, (prodMap.get(name)||0)+qty);
          });
          const email = o.email || o.customer || o.user || 'cliente@example.com';
          cliMap.set(email, (cliMap.get(email)||0)+1);
        });
        const topProducts = [...prodMap.entries()].map(([name,qty])=>({name,qty})).sort((a,b)=>b.qty-a.qty).slice(0,5);
        const topClients = [...cliMap.entries()].map(([email,qty])=>({email,qty})).sort((a,b)=>b.qty-a.qty).slice(0,5);
        return { orders, revenue, topProducts, topClients };
      }catch{ return null }
    }

    // ===== Render helpers =====
    function applySummary(ym, mountSel){
      const rep = loadReports().find(r=>r.ym===ym);
      if(!rep) return;
      const mount = document.querySelector(mountSel);
      if(!mount) return;
      mount.querySelector('[data-kpi="orders"]').textContent = (rep.orders||0).toLocaleString('es-CL');
      mount.querySelector('[data-kpi="revenue"]').textContent = currency(rep.revenue||0);
    }

    function fillList(listSel, items, formatter){
      const ol = document.querySelector(listSel); if(!ol) return;
      ol.innerHTML = '';
      items.forEach(it=>{
        const li=document.createElement('li'); li.textContent = formatter(it); ol.appendChild(li);
      });
    }

    function renderStatsForMonth(ym){
      const stats = loadStats();
      const agg = aggregateFromOrders(ym);
      const prod = agg?.topProducts || stats[ym]?.products || [];
      const clis = agg?.topClients || stats[ym]?.clients || [];
      if(ym==='2025-01'){
        if(prod.length){ fillList('#prod-2025-01', prod, x=>x.name); fillList('#qty-2025-01', prod, x=>`${x.qty} pedidos`); }
      }
      if(ym==='2025-02'){
        if(prod.length){ fillList('#prod-2025-02', prod, x=>x.name); }
        if(clis.length){ fillList('#cli-2025-02', clis, x=>`${x.email}`); }
      }
    }

    function renderAll(){
      applySummary('2025-01', '#sum-2025-01');
      applySummary('2025-02', '#sum-2025-02');
      renderStatsForMonth('2025-01');
      renderStatsForMonth('2025-02');
    }

    // ===== Eventos header =====
    document.getElementById('seedBtn').addEventListener('click', seedDemo);
    document.getElementById('clearBtn').addEventListener('click', ()=>{ localStorage.removeItem(LS_REPORTS); localStorage.removeItem(LS_STATS); renderAll(); toast('Datos borrados'); });

    // Init
    document.getElementById('year').textContent = new Date().getFullYear();
    renderAll();
  </script>
</body>
</html>
