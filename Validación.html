<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chocomanía · B-08 Validación de disponibilidad</title>
  <meta name="description" content="Validación de disponibilidad de productos antes del pago, bloqueo por falta de stock y ajuste automático del carrito.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --gap:16px; --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08);
      --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --brand:#7d3c98; --border:#e5e7eb; --accent:#a66cc4;
      --ok:#0d7a55; --warn:#92400e; --err:#991b1b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1140px; margin:0 auto; padding:20px}

    header.top{position:sticky; top:0; z-index:30; backdrop-filter:saturate(180%) blur(8px); background:rgba(246,247,251,.86); border-bottom:1px solid var(--border)}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.15rem}
    .logo{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,#522a7a,#aa6bc8); box-shadow:inset 0 0 0 2px rgba(255,255,255,.25)}
    nav ul{display:flex; gap:14px; list-style:none; margin:0; padding:0}
    nav a{padding:8px 12px; border-radius:999px}
    nav a:hover{background:#ece7f6}
    .btn{border:1px solid var(--border); background:#fff; border-radius:999px; padding:10px 14px; cursor:pointer}
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
    .btn.small{padding:8px 12px}
    .btn[disabled], .btn[aria-disabled="true"]{opacity:.5; cursor:not-allowed}

    .section{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); margin-bottom:18px}
    .muted{color:var(--muted)}

    /* Línea carrito */
    .cart{display:grid; grid-template-columns: 120px 1fr 140px 260px; gap:16px; align-items:start}
    @media (max-width: 960px){ .cart{ grid-template-columns: 100px 1fr; } .summary{margin-top:8px} }

    /* Miniatura consistente con imagen de fondo */
    .thumb{position:relative; width:100%; aspect-ratio:4/3; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#faf7ff}
    .thumb img{width:100%; height:100%; object-fit:cover; object-position:center; display:block}
    .thumb::after{content:""; position:absolute; inset:0; background:linear-gradient(to bottom right, rgba(255,255,255,.06), rgba(0,0,0,.12)); pointer-events:none}

    .info{display:flex; flex-direction:column; gap:4px}
    .name{font-weight:700}
    .price{color:#444}

    .qty{border:1px dashed #bbb; border-radius:10px; padding:10px; display:flex; flex-direction:column; gap:10px; align-items:stretch}
    .qty .box{display:flex; align-items:center; justify-content:space-between; gap:8px; border:1px dashed #ccc; border-radius:10px; padding:6px 10px}

    .summary{border:1px dashed #bbb; border-radius:10px; padding:10px; display:flex; flex-direction:column; gap:6px; align-items:flex-end; white-space:pre-line}
    .line{width:100%; display:flex; justify-content:space-between; gap:12px}
    .total{font-weight:800}

    /* Badges encima de la imagen */
    .badge{position:absolute; top:8px; left:8px; display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px dashed; font-size:.9rem; backdrop-filter:blur(2px)}
    .ok{ border-color:#7aa97a; background:#f0f8f0; color:#2c6b2c }
    .fail{ border-color:#e19a9a; background:#fde9e9; color:#7a2e2e }

    .warnbox{ padding:10px; border:1px dashed #c77; border-radius:10px; color:#7a2e2e; text-align:center; background:#fff5f5 }

    .cta{display:flex; justify-content:flex-end; margin-top:12px}

    /* Micro-animación para cambios */
    .changed{animation:flash .6s ease}
    @keyframes flash{0%{background:#fff7cc}100%{background:transparent}}

    /* Toast */
    .toast-wrap{position:fixed; top:18px; right:18px; display:grid; gap:10px; z-index:50}
    .toast{background:#111827; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); opacity:0; transform:translateY(-10px); transition:.25s}
    .toast.show{opacity:1; transform:translateY(0)}
  </style>
</head>
<body>
  <header class="top">
    <div class="container topbar">
      <div class="brand"><div class="logo" aria-hidden="true"></div> Chocomanía</div>
      <nav aria-label="principal">
        <ul>
          <li><a href="#catalogo">Catálogo</a></li>
          <li><a href="#ofertas">Ofertas</a></li>
          <li><a href="#carrito">Carrito</a></li>
          <li><a href="#ingresar">Ingresar</a></li>
        </ul>
      </nav>
      <div class="cta"><button class="btn primary" id="btnValidateTop" type="button">Validar y Continuar</button></div>
    </div>
  </header>

  <main class="container">
    <!-- Escenario 1: validación exitosa -->
    <section class="section" aria-labelledby="esc1">
      <h2 id="esc1">Validación exitosa</h2>
      <div class="cart">
        <div class="thumb">
          <img src="IMG/ChocoDubai.png" alt="Chocolate Dubai" loading="lazy">
          <div class="badge ok">✔ Stock disponible</div>
        </div>
        <div class="info"><div class="name">Producto: Chocolate Dubai</div><div class="price">Precio producto: $5.000</div></div>
        <div class="qty"><div class="box"><button class="btn small" id="e1m1">−</button><strong id="e1q1">1</strong><button class="btn small" id="e1p1">＋</button></div></div>
        <aside class="summary"><div class="line"><span>SUBTOTAL:</span><span id="e1sub1">$5.000</span></div><div class="line total"><span>TOTAL:</span><span id="e1tot">$5.000</span></div></aside>
      </div>
      <div class="cart" style="margin-top:12px;">
        <div class="thumb">
          <img src="IMG/BombonesSurt.png" alt="Bombones surtidos" loading="lazy">
          <div class="badge ok">✔ Stock disponible</div>
        </div>
        <div class="info"><div class="name">Producto: Bombones surtidos</div><div class="price">Precio producto: $4.500</div></div>
        <div class="qty"><div class="box"><button class="btn small" id="e1m2">−</button><strong id="e1q2">1</strong><button class="btn small" id="e1p2">＋</button></div></div>
        <aside class="summary"><div class="line"><span>SUBTOTAL:</span><span id="e1sub2">$4.500</span></div></aside>
      </div>
      <div class="summary" style="margin-top:10px; align-items:flex-end;"><div class="line total"><span>TOTAL:</span><span id="e1grand">$9.500</span></div></div>
      <div class="cta"><button class="btn" id="e1pay" type="button">Finalizar y Comprar</button></div>
    </section>

    <!-- Escenario 2: detecta producto sin stock → bloqueo de pago -->
    <section class="section" aria-labelledby="esc2" id="e2box" style="background:#fff5f5; border-color:#d99">
      <h2 id="esc2">Producto agotado detectado</h2>
      <div class="cart">
        <div class="thumb">
          <img src="IMG/ChocoDubai.png" alt="Chocolate Dubai" loading="lazy">
          <div class="badge ok">✔ Stock disponible</div>
        </div>
        <div class="info"><div class="name">Producto: Chocolate Dubai</div><div class="price">Precio producto: $5.000</div></div>
        <div class="qty"><div class="box"><button class="btn small" id="e2m1">−</button><strong id="e2q1">1</strong><button class="btn small" id="e2p1">＋</button></div></div>
        <aside class="summary"><div class="line"><span>&nbsp;</span><span></span></div></aside>
      </div>
      <div class="cart" style="margin-top:12px;">
        <div class="thumb">
          <img src="IMG/BombonesSurt.png" alt="Bombones surtidos" loading="lazy">
          <div class="badge fail">✖ Sin stock disponible</div>
        </div>
        <div class="info"><div class="name">Producto: Bombones surtidos</div><div class="price">Precio producto: $4.500</div></div>
        <div class="qty"><div class="box"><button class="btn small" id="e2m2">−</button><strong id="e2q2">1</strong><button class="btn small" id="e2p2">＋</button></div></div>
        <aside class="summary"><div class="line"><span>&nbsp;</span><span></span></div></aside>
      </div>
      <div class="summary" style="margin-top:10px;"><div class="line total"><span>TOTAL:</span><span id="e2grand">$9.500</span></div></div>
      <div class="warnbox" style="margin-top:10px;">Llevas un producto no disponible; no se puede continuar con el pago.</div>
      <div class="cta" style="gap:8px; justify-content:space-between; flex-wrap:wrap">
        <button class="btn small" id="e2ajustar" type="button">Ajustar automáticamente</button>
        <button class="btn" id="e2pay" type="button" disabled>Finalizar y Comprar</button>
      </div>
    </section>

    <!-- Escenario 3: ajuste automático del carrito -->
    <section class="section" aria-labelledby="esc3">
      <h2 id="esc3">Ajuste automático del carrito</h2>
      <div class="cart">
        <div class="thumb">
          <img src="IMG/ChocoDubai.png" alt="Chocolate Dubai" loading="lazy">
        </div>
        <div class="info"><div class="name">Producto: Chocolate Dubai</div><div class="price">Precio producto: $5.000</div></div>
        <div class="qty"><div class="box"><button class="btn small" id="e3m1">−</button><strong id="e3q1">1</strong><button class="btn small" id="e3p1">＋</button></div></div>
        <aside class="summary"><div class="line total"><span>TOTAL:</span><span id="e3tot">$5.000</span></div></aside>
      </div>
      <div class="cta"><button class="btn" id="e3pay" type="button">Finalizar y Comprar</button></div>
    </section>
  </main>

  <div class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <footer class="container" style="margin:18px auto 24px; color:var(--muted); text-align:center">© <span id="year"></span> Chocomanía · Validación de disponibilidad</footer>

  <script>
    const PRICE_DUBAI = 5000, PRICE_BOMBONES = 4500;
    const $ = (s)=> document.querySelector(s);
    function currency(n){ return n.toLocaleString('es-CL',{style:'currency', currency:'CLP', maximumFractionDigits:0}); }
    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.querySelector('.toast-wrap').appendChild(t); requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),200); }, 2400); }
    function flash(el){ if(!el) return; el.classList.remove('changed'); void el.offsetWidth; el.classList.add('changed'); }

    // ===== Escenario 1 =====
    let e1q1=1, e1q2=1;
    function e1Recalc(){
      const s1 = e1q1*PRICE_DUBAI, s2 = e1q2*PRICE_BOMBONES, g=s1+s2;
      $('#e1sub1').textContent = currency(s1); flash($('#e1sub1'));
      $('#e1sub2').textContent = currency(s2); flash($('#e1sub2'));
      $('#e1tot').textContent  = currency(s1); flash($('#e1tot'));
      $('#e1grand').textContent= currency(g);  flash($('#e1grand'));
    }
    $('#e1m1').addEventListener('click', ()=>{ e1q1=Math.max(1, e1q1-1); $('#e1q1').textContent=e1q1; e1Recalc(); });
    $('#e1p1').addEventListener('click', ()=>{ e1q1=Math.min(99, e1q1+1); $('#e1q1').textContent=e1q1; e1Recalc(); });
    $('#e1m2').addEventListener('click', ()=>{ e1q2=Math.max(1, e1q2-1); $('#e1q2').textContent=e1q2; e1Recalc(); });
    $('#e1p2').addEventListener('click', ()=>{ e1q2=Math.min(99, e1q2+1); $('#e1q2').textContent=e1q2; e1Recalc(); });
    $('#e1pay').addEventListener('click', ()=>{ window.location.hash = '#checkout'; toast('Validación OK. Redirigiendo a pago…'); });

    // ===== Escenario 2 (bombones sin stock) =====
    let e2q1=1, e2q2=1;
    function e2Recalc(){
      $('#e2grand').textContent = currency(e2q1*PRICE_DUBAI + e2q2*PRICE_BOMBONES);
      flash($('#e2grand'));
    }
    $('#e2m1').addEventListener('click', ()=>{ e2q1=Math.max(1, e2q1-1); $('#e2q1').textContent=e2q1; e2Recalc(); });
    $('#e2p1').addEventListener('click', ()=>{ e2q1=Math.min(99, e2q1+1); $('#e2q1').textContent=e2q1; e2Recalc(); });
    $('#e2m2').addEventListener('click', ()=>{ e2q2=Math.max(0, e2q2-1); $('#e2q2').textContent=e2q2; e2Recalc(); });
    $('#e2p2').addEventListener('click', ()=>{ e2q2=Math.min(99, e2q2+1); $('#e2q2').textContent=e2q2; e2Recalc(); });
    $('#e2ajustar').addEventListener('click', ()=>{ e2q2=0; $('#e2q2').textContent='0'; e2Recalc(); toast('Se ajustó el carrito: Bombones quitados'); });
    $('#e2pay').addEventListener('click', ()=> toast('No puedes continuar: hay productos sin stock.'));

    // ===== Escenario 3 (ajustado) =====
    let e3q1=1; function e3Recalc(){ $('#e3tot').textContent = currency(e3q1*PRICE_DUBAI); flash($('#e3tot')); }
    $('#e3m1').addEventListener('click', ()=>{ e3q1=Math.max(1, e3q1-1); $('#e3q1').textContent=e3q1; e3Recalc(); });
    $('#e3p1').addEventListener('click', ()=>{ e3q1=Math.min(99, e3q1+1); $('#e3q1').textContent=e3q1; e3Recalc(); });
    $('#e3pay').addEventListener('click', ()=>{ window.location.hash = '#checkout'; toast('Carrito ajustado. Redirigiendo a pago…'); });

    // Simulaciones
    $('#simE1').addEventListener('click', ()=>{ e1q1=1; e1q2=1; $('#e1q1').textContent='1'; $('#e1q2').textContent='1'; e1Recalc(); toast('E1 listo'); });
    $('#simE2').addEventListener('click', ()=>{ e2q1=1; e2q2=1; $('#e2q1').textContent='1'; $('#e2q2').textContent='1'; e2Recalc(); toast('E2: Bombones sin stock'); });
    $('#simE3').addEventListener('click', ()=>{ e3q1=1; $('#e3q1').textContent='1'; e3Recalc(); toast('E3 listo'); });

    document.getElementById('btnValidateTop').addEventListener('click', ()=> toast('Validación general (demo)'));

    // Init
    e1Recalc(); e2Recalc(); e3Recalc();
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
