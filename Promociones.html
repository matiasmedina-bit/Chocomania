<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chocomanía · B-07 Promociones y Totales</title>
  <meta name="description" content="Cálculo de promociones (cupón y 3×2), envío por comuna y total final.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --gap:16px; --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08);
      --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --brand:#7d3c98; --border:#e5e7eb; --accent:#a66cc4; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1140px; margin:0 auto; padding:20px}

    header.top{position:sticky; top:0; z-index:30; backdrop-filter:saturate(180%) blur(8px); background:rgba(246,247,251,.86); border-bottom:1px solid var(--border)}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.15rem}
    .logo{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,#522a7a,#aa6bc8); box-shadow:inset 0 0 0 2px rgba(255,255,255,.25)}
    nav ul{display:flex; gap:14px; list-style:none; margin:0; padding:0}
    nav a{padding:8px 12px; border-radius:999px}
    nav a:hover{background:#ece7f6}
    .btn{border:1px solid var(--border); background:#fff; border-radius:999px; padding:10px 14px; cursor:pointer}
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
    .btn.small{padding:8px 12px}

    .section{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); margin-bottom:18px}
    .muted{color:var(--muted)}

    /* Carrito: imagen | info | cantidad | resumen */
    .cart{display:grid; grid-template-columns: 140px 1fr 140px 260px; gap:16px; align-items:start}
    @media (max-width: 980px){ .cart{ grid-template-columns: 120px 1fr; } .summary{margin-top:8px} }

    /* Miniatura consistente (4:3, cover) */
    .thumb{width:100%; aspect-ratio:4/3; border:1px solid var(--border); border-radius:12px; background:#faf7ff; overflow:hidden}
    .thumb img{width:100%; height:100%; object-fit:cover; object-position:center; display:block}

    .info{display:flex; flex-direction:column; gap:4px}
    .name{font-weight:700}
    .price{color:#444}
    .note{font-size:.9rem; color:#555; margin-top:4px}

    .qty{border:1px dashed #bbb; border-radius:10px; padding:10px; display:flex; flex-direction:column; gap:10px; align-items:stretch}
    .qty .box{display:flex; align-items:center; justify-content:space-between; gap:8px; border:1px dashed #ccc; border-radius:10px; padding:6px 10px}

    .summary{border:1px dashed #bbb; border-radius:10px; padding:10px; display:flex; flex-direction:column; gap:8px; align-items:flex-end}
    .summary .line{width:100%; display:flex; justify-content:space-between; gap:12px}
    .summary .total{font-weight:800; font-size:1.1rem}
    .coupon, .ship{width:100%; display:flex; gap:8px; align-items:center}
    .coupon input{flex:1; padding:8px 10px; border:1px solid #ccc; border-radius:8px; background:#fafafa}
    .coupon .apply{padding:8px 12px; border:1px solid var(--border); background:#fff; border-radius:999px; cursor:pointer}
    .ship select{flex:1; padding:8px 10px; border:1px solid #ccc; border-radius:8px; background:#fafafa}

    .cta{display:flex; justify-content:flex-end; margin-top:12px}

    /* Micro-animación para cambios */
    .changed{animation:flash .6s ease}
    @keyframes flash{0%{background:#fff7cc}100%{background:transparent}}

    /* Toast */
    .toast-wrap{position:fixed; top:18px; right:18px; display:grid; gap:10px; z-index:50}
    .toast{background:#111827; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); opacity:0; transform:translateY(-10px); transition:.25s}
    .toast.show{opacity:1; transform:translateY(0)}
  </style>
</head>
<body>
  <header class="top">
    <div class="container topbar">
      <div class="brand"><div class="logo" aria-hidden="true"></div> Chocomanía</div>
      <nav aria-label="principal">
        <ul>
          <li><a href="Visualización Catalogo.html">Catálogo</a></li>
          <li><a href="Promociones.html">Ofertas</a></li>
          <li><a href="Armado.html">Carrito</a></li>
          <li><a href="Acesso Usuarios.html">Ingresar</a></li>
        </ul>
      </nav>
      <div class="cta"><button class="btn primary" id="btnCheckoutTop" type="button">Finalizar y Comprar</button></div>
    </div>
  </header>

  <main class="container">
    <!-- Escenario 1: Cupón + envío (aparece al aplicar cupón) -->
    <section class="section" aria-labelledby="esc1">
      <h2 id="esc1">Aplicación de cupón</h2>
      <div class="cart">
        <div class="thumb">
          <img src="IMG/ChocoDubai.png" alt="Chocolate Dubai" loading="lazy">
        </div>
        <div class="info">
          <div class="name">Producto: Chocolate Dubai</div>
          <div class="price">Precio producto: $5.000</div>
          <div class="note">Cupón válido: <strong>CHOCO10</strong> (10% sin mínimo)</div>
        </div>
        <div class="qty">
          <div class="box"><button class="btn small" id="m1">−</button><strong id="q1">4</strong><button class="btn small" id="p1">＋</button></div>
        </div>
        <aside class="summary">
          <div class="coupon">
            <label for="cup1">Cupón:</label>
            <input id="cup1" placeholder="CHOCO10" />
            <button class="apply" id="apply1">Aplicar</button>
          </div>

          <!-- Envío dinámico tras cupón -->
          <div class="ship" id="ship1_wrap" style="display:none">
            <label for="comuna1">Envío:</label>
            <select id="comuna1">
              <option value="Centro">Centro ($2.500)</option>
              <option value="Norte">Norte ($3.000)</option>
              <option value="Oriente">Oriente ($3.500)</option>
              <option value="Sur">Sur ($2.800)</option>
              <option value="Retiro">Retiro en tienda ($0)</option>
            </select>
          </div>

          <div class="line"><span>SUBTOTAL:</span><span id="s1_sub">$20.000</span></div>
          <div class="line" id="s1_cup_line" style="display:none"><span>Descuento cupón (10%):</span><span id="s1_cup">−$0</span></div>
          <div class="line" id="s1_ship_line" style="display:none"><span>Delivery (<span id="s1_zone">Comuna Centro</span>):</span><span id="s1_ship">$0</span></div>
          <div class="line total"><span>TOTAL:</span><span id="s1_tot">$18.000</span></div>
        </aside>
      </div>
      <div class="cta"><button class="btn" type="button" id="btn1">Finalizar y Comprar</button></div>
      <p class="muted" style="margin-top:6px">Aplica cupón → aparece envío y el total se recalcula automáticamente.</p>
    </section>

    <!-- Escenario 2: Promoción por cantidad 3×2 (condicional) -->
    <section class="section" aria-labelledby="esc2">
      <h2 id="esc2">Promoción por cantidad (3×2)</h2>
      <div class="cart">
        <div class="thumb">
          <img src="IMG/ChocoDubai.png" alt="Chocolate Dubai" loading="lazy">
        </div>
        <div class="info">
          <div class="name">Producto: Chocolate Dubai</div>
          <div class="price">Precio producto: $5.000</div>
          <div class="note" id="note2">Lleva <strong>3</strong> y paga <strong>2</strong>. (faltan <span id="miss2">0</span>)</div>
        </div>
        <div class="qty">
          <div class="box"><button class="btn small" id="m2">−</button><strong id="q2">3</strong><button class="btn small" id="p2">＋</button></div>
        </div>
        <aside class="summary">
          <div class="line"><span>SUBTOTAL:</span><span id="s2_sub">$15.000</span></div>
          <div class="line" id="s2_promo_line" style="display:none"><span>Promoción aplicada (3×2):</span><span id="s2_promo">−$5.000</span></div>
          <div class="line total"><span>TOTAL:</span><span id="s2_tot">$10.000</span></div>
        </aside>
      </div>
      <div class="cta"><button class="btn" type="button" id="btn2">Finalizar y Comprar</button></div>
    </section>

    <!-- Escenario 3: Envío por comuna + 3×2 (condicional) -->
    <section class="section" aria-labelledby="esc3">
      <h2 id="esc3">Total final con envío</h2>
      <div class="cart">
        <div class="thumb">
          <img src="IMG/ChocoDubai.png" alt="Chocolate Dubai" loading="lazy">
        </div>
        <div class="info">
          <div class="name">Producto: Chocolate Dubai</div>
          <div class="price">Precio producto: $5.000</div>
          <div class="note" id="note3">Lleva <strong>3</strong> y paga <strong>2</strong>. (faltan <span id="miss3">0</span>)</div>
        </div>
        <div class="qty">
          <div class="box"><button class="btn small" id="m3">−</button><strong id="q3">3</strong><button class="btn small" id="p3">＋</button></div>
        </div>
        <aside class="summary">
          <div class="ship">
            <label for="comuna">Comuna:</label>
            <select id="comuna">
              <option value="Centro">Centro ($2.500)</option>
              <option value="Norte">Norte ($3.000)</option>
              <option value="Oriente">Oriente ($3.500)</option>
              <option value="Sur">Sur ($2.800)</option>
              <option value="Retiro">Retiro en tienda ($0)</option>
            </select>
          </div>
          <div class="line"><span>SUBTOTAL:</span><span id="s3_sub">$15.000</span></div>
          <div class="line" id="s3_promo_line" style="display:none"><span>Promoción aplicada:</span><span id="s3_promo">−$5.000</span></div>
          <div class="line"><span>Delivery (<span id="s3_zone">Comuna Centro</span>):</span><span id="s3_ship">$2.500</span></div>
          <div class="line total"><span>TOTAL:</span><span id="s3_tot">$12.500</span></div>
        </aside>
      </div>
      <div class="cta"><button class="btn" type="button" id="btn3">Finalizar y Comprar</button></div>
    </section>
  </main>

  <div class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <footer class="container" style="margin:18px auto 24px; color:var(--muted); text-align:center">
    © <span id="year"></span> Chocomanía · Promociones y Totales
  </footer>

  <script>
    // === Config ===
    const PRICE = 5000; // Chocolate Dubai
    const COUPON = 'CHOCO10';
    const COUPON_PCT = 0.10; // 10%
    const SHIP = { Centro:2500, Norte:3000, Oriente:3500, Sur:2800, Retiro:0 };

    const $ = (s)=> document.querySelector(s);
    function currency(n){ return n.toLocaleString('es-CL', {style:'currency', currency:'CLP', maximumFractionDigits:0}); }
    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.querySelector('.toast-wrap').appendChild(t); requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),200); }, 2400); }
    function flash(el){ if(!el) return; el.classList.remove('changed'); void el.offsetWidth; el.classList.add('changed'); }

    // -------- Escenario 1 (Cupón + envío dinámico) ----------
    const q1El = $('#q1'), s1_sub=$('#s1_sub'), s1_cup=$('#s1_cup'), s1_tot=$('#s1_tot'),
          s1_cup_line=$('#s1_cup_line'), ship1Wrap=$('#ship1_wrap'),
          s1_ship_line=$('#s1_ship_line'), s1_ship=$('#s1_ship'), s1_zone=$('#s1_zone'),
          comuna1Sel=$('#comuna1'), cup1=$('#cup1'), apply1=$('#apply1');
    let q1=4, cup1Applied=false, comuna1='Centro';

    function recalcE1(){
      const subtotal = q1 * PRICE;
      s1_sub.textContent = currency(subtotal); flash(s1_sub);

      const valid = cup1Applied && cup1.value.trim().toUpperCase()===COUPON && subtotal>0;
      const disc = valid ? Math.round(subtotal * COUPON_PCT) : 0;
      s1_cup_line.style.display = disc>0 ? 'flex' : 'none';
      s1_cup.textContent = '−' + currency(disc); if(disc>0) flash(s1_cup);

      // Envío aparece SOLO si el cupón está aplicado correctamente
      ship1Wrap.style.display = valid ? 'flex' : 'none';
      s1_ship_line.style.display = valid ? 'flex' : 'none';
      let ship = 0;
      if(valid){
        ship = SHIP[comuna1];
        s1_ship.textContent = currency(ship); flash(s1_ship);
        s1_zone.textContent = 'Comuna ' + (comuna1==='Retiro'?'Retiro en tienda':comuna1);
      }
      s1_tot.textContent = currency(subtotal - disc + ship); flash(s1_tot);
    }

    $('#m1').addEventListener('click', ()=>{ q1=Math.max(1,q1-1); q1El.textContent=q1; recalcE1(); });
    $('#p1').addEventListener('click', ()=>{ q1=Math.min(99,q1+1); q1El.textContent=q1; recalcE1(); });
    apply1.addEventListener('click', ()=>{
      cup1Applied=true;
      if(cup1.value.trim().toUpperCase()!==COUPON){ toast('Cupón inválido'); } else { toast('Cupón aplicado'); }
      recalcE1();
    });
    comuna1Sel && comuna1Sel.addEventListener('change', ()=>{ comuna1 = comuna1Sel.value; recalcE1(); });

    // -------- Escenario 2 (3×2 condicional) ----------
    const q2El=$('#q2'), s2_sub=$('#s2_sub'), s2_promo=$('#s2_promo'), s2_tot=$('#s2_tot'),
          s2_promo_line=$('#s2_promo_line'), note2=$('#note2'), miss2=$('#miss2');
    let q2=3;
    const promoDiscount = (q)=> Math.floor(q/3) * PRICE;

    function recalcE2(){
      const subtotal = q2 * PRICE, disc = promoDiscount(q2);
      s2_sub.textContent = currency(subtotal); flash(s2_sub);

      // mostrar / ocultar promo
      s2_promo_line.style.display = disc>0 ? 'flex' : 'none';
      s2_promo.textContent = '−' + currency(disc); if(disc>0) flash(s2_promo);

      // Mensaje de estado
      const faltan = (3 - (q2 % 3)) % 3; // 0 si aplica
      miss2.textContent = faltan;
      note2.innerHTML = faltan === 0
        ? 'Promoción <strong>3×2 aplicada</strong>.'
        : `Lleva <strong>3</strong> y paga <strong>2</strong>. (faltan <strong>${faltan}</strong>)`;

      s2_tot.textContent = currency(subtotal - disc); flash(s2_tot);
    }
    $('#m2').addEventListener('click', ()=>{ q2=Math.max(1,q2-1); q2El.textContent=q2; recalcE2(); });
    $('#p2').addEventListener('click', ()=>{ q2=Math.min(99,q2+1); q2El.textContent=q2; recalcE2(); });

    // -------- Escenario 3 (3×2 + envío) ----------
    const q3El=$('#q3'), s3_sub=$('#s3_sub'), s3_promo=$('#s3_promo'), s3_tot=$('#s3_tot'),
          s3_ship=$('#s3_ship'), s3_zone=$('#s3_zone'), s3_promo_line=$('#s3_promo_line'),
          comunaSel=$('#comuna'), note3=$('#note3'), miss3=$('#miss3');
    let q3=3, comuna='Centro';

    function recalcE3(){
      const subtotal = q3 * PRICE, disc = promoDiscount(q3), ship = SHIP[comuna];
      s3_sub.textContent = currency(subtotal); flash(s3_sub);

      s3_promo_line.style.display = disc>0 ? 'flex' : 'none';
      s3_promo.textContent = '−' + currency(disc); if(disc>0) flash(s3_promo);

      const faltan = (3 - (q3 % 3)) % 3;
      miss3.textContent = faltan;
      note3.innerHTML = faltan === 0
        ? 'Promoción <strong>3×2 aplicada</strong>.'
        : `Lleva <strong>3</strong> y paga <strong>2</strong>. (faltan <strong>${faltan}</strong>)`;

      s3_ship.textContent = currency(ship); s3_zone.textContent = 'Comuna ' + (comuna==='Retiro'?'Retiro en tienda':comuna); flash(s3_ship);
      s3_tot.textContent = currency(subtotal - disc + ship); flash(s3_tot);
    }
    $('#m3').addEventListener('click', ()=>{ q3=Math.max(1,q3-1); q3El.textContent=q3; recalcE3(); });
    $('#p3').addEventListener('click', ()=>{ q3=Math.min(99,q3+1); q3El.textContent=q3; recalcE3(); });
    comunaSel.addEventListener('change', ()=>{ comuna = comunaSel.value; recalcE3(); });

    // Simulaciones
    $('#simE1').addEventListener('click', ()=>{ q1=4; q1El.textContent=q1; cup1.value=COUPON; cup1Applied=true; comuna1Sel.value='Centro'; comuna1='Centro'; recalcE1(); toast('Escenario 1 preparado'); });
    $('#simE2').addEventListener('click', ()=>{ q2=3; q2El.textContent=q2; recalcE2(); toast('Escenario 2 preparado'); });
    $('#simE3').addEventListener('click', ()=>{ q3=3; q3El.textContent=q3; comunaSel.value='Centro'; comuna='Centro'; recalcE3(); toast('Escenario 3 preparado'); });

    // Checkout (demo)
    function goCheckout(){ window.location.hash = '#checkout'; toast('Redirigiendo a pago…'); }
    document.getElementById('btnCheckoutTop').addEventListener('click', goCheckout);
    document.getElementById('btn1').addEventListener('click', goCheckout);
    document.getElementById('btn2').addEventListener('click', goCheckout);
    document.getElementById('btn3').addEventListener('click', goCheckout);

    // Init
    recalcE1(); recalcE2(); recalcE3();
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
