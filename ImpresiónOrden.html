<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chocomanía · B-13 Impresión de órdenes</title>
  <meta name="description" content="Cola de impresión cronológica, prevención de duplicados y historial con trazabilidad por usuario.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --gap:16px; --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08);
      --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --brand:#7d3c98; --border:#e5e7eb;
      --ok:#0d7a55; --warn:#92400e; --err:#991b1b; --info:#1d4ed8; --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1140px; margin:0 auto; padding:20px}

    header.top{position:sticky; top:0; z-index:30; backdrop-filter:saturate(180%) blur(8px); background:rgba(246,247,251,.86); border-bottom:1px solid var(--border)}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.15rem}
    .logo{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,#522a7a,#aa6bc8); box-shadow:inset 0 0 0 2px rgba(255,255,255,.25)}
    nav ul{display:flex; gap:14px; list-style:none; margin:0; padding:0}
    nav a{padding:8px 12px; border-radius:999px}
    nav a:hover{background:#ece7f6}

    .btn{border:1px solid var(--border); background:#fff; border-radius:999px; padding:8px 14px; cursor:pointer}
    .btn[disabled]{opacity:.45; cursor:not-allowed}
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
    .btn.small{padding:6px 10px}

    .section{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); margin-bottom:18px}
    .muted{color:var(--muted)}
    .list{display:grid; gap:10px}
    .rowItem{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:12px; border:1px dashed #cfcfcf; border-radius:10px; padding:12px; background:#fafafa; font-weight:700}
    .rowItem[data-active="true"]{outline:2px solid #c7a6ea; background:#f8f6ff}

    /* Badges */
    .badge{padding:2px 8px; border-radius:999px; font-weight:700; font-size:.75rem; display:inline-block}
    .b-pend{background:#eef2ff; color:#3730a3}
    .b-ok{background:#ecfdf5; color:#047857}
    .b-re{background:#fff7ed; color:#9a3412}

    .note{margin-top:10px; padding:10px; border:1px dashed #bbb; border-radius:10px; background:#fffef4; text-align:center}

    /* Duplicado controlado */
    .dupCtrl{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0}
    .dupCtrl input[type="text"]{padding:8px 10px; border:1px solid #d1d5db; border-radius:10px; width:min(320px, 80vw)}

    /* Tabs */
    .tabs{display:flex; gap:6px; flex-wrap:wrap}
    .tab{border:1px solid var(--border); padding:6px 10px; border-radius:999px; cursor:pointer; background:#fff}
    .tab.active{background:#ece7f6; border-color:#d9c8f0}

    /* Toast */
    .toast-wrap{position:fixed; top:18px; right:18px; display:grid; gap:10px; z-index:50}
    .toast{background:#111827; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); opacity:0; transform:translateY(-10px); transition:.25s}
    .toast.show{opacity:1; transform:translateY(0)}
  </style>
</head>
<body>
  <header class="top">
    <div class="container topbar">
      <div class="brand"><div class="logo" aria-hidden="true"></div> Chocomanía</div>
      <nav aria-label="principal">
        <ul>
          <li><a href="#esc1">Cola</a></li>
          <li><a href="#esc2">Duplicados</a></li>
          <li><a href="#esc3">Historial</a></li>
        </ul>
      </nav>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <label>Usuario actual
          <select id="userSel" style="padding:8px 10px; border:1px solid #d1d5db; border-radius:10px">
            <option>juanito</option><option>marta</option><option>lucia</option><option>pedro</option>
          </select>
        </label>
        <button class="btn small" id="importDisp" type="button">Importar desde Despacho</button>
        <button class="btn small" id="seedBtn" type="button">Sembrar cola</button>
        <button class="btn small" id="clearBtn" type="button">Limpiar datos</button>
        <button class="btn primary" id="printNextBtn" type="button" title="Ctrl+P">Imprimir siguiente</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Escenario 1: Impresión en orden cronológico -->
    <section class="section" aria-labelledby="esc1">
      <h2 id="esc1">Impresión en orden cronológico</h2>
      <div class="list" id="queueList"></div>
    </section>

    <!-- Escenario 2: Evitar impresión duplicada -->
    <section class="section" aria-labelledby="esc2">
      <h2 id="esc2">Evitar impresión duplicada</h2>
      <div class="dupCtrl">
        <label><input type="checkbox" id="allowReprint"> Permitir reimpresión</label>
        <input id="reprintWhy" type="text" placeholder="Motivo (p.ej., impresora atascada)" disabled>
      </div>
      <div class="list" id="dupList"></div>
      <div class="note" id="dupNote" style="display:none">Orden ya impresa. Activa “Permitir reimpresión” y especifica motivo para proceder.</div>
    </section>

    <!-- Escenario 3: Registro en historial -->
    <section class="section" aria-labelledby="esc3">
      <h2 id="esc3">Historial de impresiones</h2>
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px">
        <div class="tabs">
          <button class="tab active" data-filter="all">Todos</button>
          <button class="tab" data-filter="today">Hoy</button>
          <button class="tab" data-filter="user">Usuario actual</button>
          <button class="tab" data-filter="reprint">Reimpresiones</button>
        </div>
        <button class="btn small" id="exportCsv" type="button">Exportar CSV</button>
      </div>
      <div class="list" id="historyList"></div>
    </section>
  </main>

  <div class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <footer class="container" style="margin:18px auto 24px; color:var(--muted); text-align:center">© <span id="year"></span> Chocomanía · Impresión de órdenes</footer>

  <script>
    // ===== Utilidades =====
    const $ = (s)=> document.querySelector(s);
    const $$ = (s)=> document.querySelectorAll(s);
    const pad = (n)=> String(n).padStart(2,'0');
    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.querySelector('.toast-wrap').appendChild(t); requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),200); }, 2200); }
    function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    // ===== Almacenamiento =====
    const LS_PQ='choco_print_queue', LS_PH='choco_print_history', LS_USER='choco_print_user';
    const LS_DISP='choco_dispatch_orders'; // de B-12

    const loadQueue = ()=> JSON.parse(localStorage.getItem(LS_PQ)||'[]');
    const saveQueue = (arr)=> localStorage.setItem(LS_PQ, JSON.stringify(arr));
    const loadHist  = ()=> JSON.parse(localStorage.getItem(LS_PH)||'[]');
    const saveHist  = (arr)=> localStorage.setItem(LS_PH, JSON.stringify(arr));

    // ===== Sembrar datos base =====
    function seedQueue(){
      const y=new Date().getFullYear();
      const arr=[
        {id:`ORD-${y}-122`, time:'17:01', printedAt:null, printedBy:null, status:'PENDIENTE'},
        {id:`ORD-${y}-123`, time:'17:04', printedAt:null, printedBy:null, status:'PENDIENTE'},
        {id:`ORD-${y}-124`, time:'17:05', printedAt:null, printedBy:null, status:'PENDIENTE'}
      ];
      saveQueue(arr); renderAll(); toast('Cola sembrada');
    }

    // ===== Importar desde despacho (B-12) =====
    function importFromDispatch(){
      const disp = JSON.parse(localStorage.getItem(LS_DISP)||'[]');
      if(!disp.length){ toast('No hay órdenes en Despacho'); return; }
      const q = loadQueue();
      // importamos solo generando/asignado/en ruta que no existan aún
      const candidates = disp.filter(o=>['generando','asignado','en ruta'].includes(o.status))
        .map(o=>({id:o.id, time:new Date(o.date).toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'}), printedAt:null, printedBy:null, status:'PENDIENTE'}))
        .filter(o=> !q.some(x=>x.id===o.id));
      if(!candidates.length){ toast('Nada que importar'); return; }
      const merged=[...q, ...candidates].sort((a,b)=> a.time.localeCompare(b.time));
      saveQueue(merged); renderAll(); toast(`Importadas ${candidates.length} orden(es)`);
    }

    // ===== Helpers =====
    function nextPrintableIndex(arr){ return arr.findIndex(x=>!x.printedAt); }
    function badge(status){
      if(status==='REIMPRESA') return '<span class="badge b-re">REIMPRESA</span>';
      if(status==='IMPRESA') return '<span class="badge b-ok">IMPRESA</span>';
      return '<span class="badge b-pend">PENDIENTE</span>';
    }

    // ===== Ventana de impresión =====
    function openPrintWindow(order, isReprint=false, reason=''){
      const w=window.open('', '_blank', 'width=680,height=800');
      const html=`<!doctype html><html><head><meta charset='utf-8'><title>${order.id}</title>
      <style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px}h1{margin:0 0 12px}table{border-collapse:collapse;width:100%}td,th{border:1px solid #e5e7eb;padding:8px 10px}</style>
      </head><body>
      <h1>Orden ${order.id}</h1>
      <p><strong>Fecha:</strong> ${todayStr()} · <strong>Hora:</strong> ${order.time}</p>
      <table><tr><th>Campo</th><th>Valor</th></tr>
      <tr><td>Impreso por</td><td>${order.printedBy}</td></tr>
      <tr><td>Impreso a las</td><td>${new Date(order.printedAt).toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'})}</td></tr>
      <tr><td>Estado</td><td>${isReprint?'REIMPRESA':'IMPRESA'}</td></tr>
      ${isReprint?`<tr><td>Motivo reimpresión</td><td>${reason||'-'}</td></tr>`:''}
      </table>
      <script>setTimeout(()=>{try{window.print()}catch(e){}}, 250)<\/script>
      </body></html>`;
      w.document.write(html); w.document.close();
    }

    // ===== Lógica de impresión =====
    function doPrint(id, opts={allowReprint:false, reason:''}){
      const q=loadQueue(); const i=q.findIndex(x=>x.id===id); if(i<0) return;
      const user = $('#userSel').value || 'juanito'; localStorage.setItem(LS_USER, user);
      const item=q[i];
      const nextIdx = nextPrintableIndex(q);

      // Ya impresa => requiere reimpresión autorizada
      if(item.printedAt){
        $('#dupNote').style.display='block';
        if(!opts.allowReprint){ toast('Orden ya impresa'); renderAll(); return; }
        // registrar reimpresión
        const now=Date.now();
        const hist = loadHist();
        hist.unshift({id:item.id, time:item.time, user, printedAt:now, status:'REIMPRESA', reason:opts.reason||'(sin motivo)'});
        saveHist(hist);
        openPrintWindow({ ...item, printedBy:user, printedAt:now }, true, opts.reason);
        toast('Reimpresión enviada');
        renderAll();
        return;
      }

      // En cola: solo la siguiente
      if(i!==nextIdx){ toast('Debes imprimir en orden cronológico'); return; }

      item.printedAt = Date.now(); item.printedBy = user; item.status='IMPRESA';
      saveQueue(q);

      const hist = loadHist();
      hist.unshift({id:item.id, time:item.time, user, printedAt:item.printedAt, status:'IMPRESA'});
      saveHist(hist);

      toast('Imprimiendo '+item.id+'…');
      openPrintWindow(item, false);
      renderAll();
    }

    // ===== Render Cola =====
    function renderQueue(){
      const box=$('#queueList'); box.innerHTML='';
      const q=loadQueue().slice().sort((a,b)=> a.time.localeCompare(b.time));
      const nextIdx=nextPrintableIndex(q);
      if(q.length===0){ box.innerHTML='<div class="muted">No hay órdenes en la cola.</div>'; return; }
      q.forEach((o, idx)=>{
        const row=document.createElement('div'); row.className='rowItem'; row.dataset.active = (idx===nextIdx && !o.printedAt);
        row.innerHTML=`<div>${o.id}: <span class="muted">${o.time}</span> ${badge(o.status||'PENDIENTE')}</div>`;
        const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Imprimir';
        btn.disabled = !!o.printedAt || (idx!==nextIdx);
        btn.addEventListener('click', ()=> doPrint(o.id));
        row.appendChild(btn); box.appendChild(row);
      });
    }

    // ===== Render Duplicados =====
    function renderDup(){
      const box=$('#dupList'); box.innerHTML=''; $('#dupNote').style.display='none';
      const q=loadQueue().slice().sort((a,b)=> a.time.localeCompare(b.time));
      if(q.length===0){ box.innerHTML='<div class="muted">No hay órdenes.</div>'; return; }

      q.forEach(o=>{
        const row=document.createElement('div'); row.className='rowItem';
        row.innerHTML=`<div>${o.id}: <span class="muted">${o.time}</span> ${badge(o.status||'PENDIENTE')}</div>`;
        const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Imprimir';
        btn.disabled = !o.printedAt && !$('#allowReprint').checked; // solo si ya fue impresa y con toggle activo
        btn.addEventListener('click', ()=>{
          const allow = $('#allowReprint').checked;
          const why = $('#reprintWhy').value.trim();
          if(!o.printedAt){ toast('Aún no se ha impreso la orden original'); return; }
          if(!allow){ $('#dupNote').style.display='block'; toast('Activa “Permitir reimpresión”'); return; }
          doPrint(o.id, {allowReprint:true, reason:why});
        });
        row.appendChild(btn); box.appendChild(row);
      });
    }

    // ===== Render Historial =====
    function renderHistory(filter='all'){
      const box=$('#historyList'); box.innerHTML='';
      const hist=loadHist();
      if(hist.length===0){ box.innerHTML='<div class="muted">Aún no hay impresiones.</div>'; return; }

      const user = $('#userSel').value;
      const startOfDay = new Date(todayStr()+' 00:00').getTime();

      const keep = h=>{
        if(filter==='today') return h.printedAt >= startOfDay;
        if(filter==='user')  return h.user === user;
        if(filter==='reprint') return h.status==='REIMPRESA';
        return true;
      };

      hist.filter(keep).forEach(h=>{
        const when = new Date(h.printedAt).toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'});
        const bad = (h.status==='REIMPRESA') ? 'b-re' : 'b-ok';
        const row=document.createElement('div'); row.className='rowItem';
        row.innerHTML = `<div>${h.id}: <span class="muted">${h.time || when}, ${h.user}</span> <span class="badge ${bad}">${h.status}</span>${h.reason? ' · <span class="muted">(' + h.reason + ')</span>':''}</div><div></div>`;
        box.appendChild(row);
      });
    }

    function renderAll(){ renderQueue(); renderDup(); renderHistory($(".tab.active")?.dataset.filter||'all'); }

    // ===== Exportar CSV =====
    function exportCSV(){
      const hist=loadHist();
      if(!hist.length){ toast('No hay datos'); return; }
      const rows=[['id','hora','usuario','timestamp','status','motivo']];
      hist.forEach(h=> rows.push([h.id, h.time||'', h.user, h.printedAt, h.status, h.reason||'']));
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='historial_impresiones.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // ===== Eventos header / UI =====
    $('#seedBtn').addEventListener('click', seedQueue);
    $('#importDisp').addEventListener('click', importFromDispatch);
    $('#clearBtn').addEventListener('click', ()=>{ localStorage.removeItem(LS_PQ); localStorage.removeItem(LS_PH); renderAll(); toast('Datos limpiados'); });
    $('#userSel').addEventListener('change', ()=>{ localStorage.setItem(LS_USER, $('#userSel').value); toast('Usuario: '+$('#userSel').value); renderHistory($(".tab.active")?.dataset.filter||'all'); });

    // reimpresión controlada
    $('#allowReprint').addEventListener('change', (e)=>{ $('#reprintWhy').disabled = !e.target.checked; renderDup(); });
    $('#reprintWhy').addEventListener('input', ()=>{/* solo informativo */});

    // tabs historial
    $$('.tab').forEach(b=> b.addEventListener('click', ()=>{ $$('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderHistory(b.dataset.filter); }));

    // imprimir siguiente (botón y atajo)
    function printNext(){
      const q=loadQueue(); const idx=nextPrintableIndex(q);
      if(idx<0){ toast('No hay pendientes'); return; }
      doPrint(q[idx].id);
    }
    $('#printNextBtn').addEventListener('click', printNext);
    window.addEventListener('keydown', (e)=>{ if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='p'){ e.preventDefault(); printNext(); } });

    // ===== Init =====
    (function init(){
      const u = localStorage.getItem(LS_USER); if(u){ $('#userSel').value=u; }
      if(!loadQueue().length){ seedQueue(); } else { renderAll(); }
      $('#exportCsv').addEventListener('click', exportCSV);
      document.getElementById('year').textContent = new Date().getFullYear();
    })();
  </script>
</body>
</html>
