<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chocomanía · B‑10 Boleta digital</title>
  <meta name="description" content="Boleta digital: generar, enviar (simulado), ver correo con adjunto y descargar/imprimir la boleta. Historial de compras con descarga.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --gap:16px; --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08);
      --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --brand:#7d3c98; --border:#e5e7eb; --accent:#a66cc4;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1140px; margin:0 auto; padding:20px}

    header.top{position:sticky; top:0; z-index:30; backdrop-filter:saturate(180%) blur(8px); background:rgba(246,247,251,.86); border-bottom:1px solid var(--border)}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.15rem}
    .logo{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,#522a7a,#aa6bc8); box-shadow:inset 0 0 0 2px rgba(255,255,255,.25)}
    nav ul{display:flex; gap:14px; list-style:none; margin:0; padding:0}
    nav a{padding:8px 12px; border-radius:999px}
    nav a:hover{background:#ece7f6}
    .btn{border:1px solid var(--border); background:#fff; border-radius:999px; padding:10px 14px; cursor:pointer}
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
    .btn.small{padding:8px 12px}

    .section{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); margin-bottom:18px}
    .muted{color:var(--muted)}

    /* Mail y adjunto */
    .mail{border:1px dashed #cfcfcf; border-radius:12px; padding:16px; background:#fff; display:grid; gap:12px}
    .attach{border:1px dashed #bbb; border-radius:10px; padding:10px; display:flex; align-items:center; justify-content:space-between; gap:10px}

    /* Historial */
    .list{display:grid; gap:10px}
    .rowItem{display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; border:1px solid #e5e7eb; border-radius:10px; padding:10px; background:#fff}

    /* Modal simple */
    dialog{border:none; padding:0; background:transparent}
    .modal{width:min(460px, 92vw); margin:20px auto; padding:16px; border:2px dashed #9e9e9e; border-radius:12px; background:#fafafa; display:flex; flex-direction:column; gap:12px; align-items:center; text-align:center}

    /* Invoice (para impresión) */
    .invoice{max-width:760px; margin:0 auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:18px}
    .inv-head{display:flex; justify-content:space-between; align-items:flex-start}
    .inv-title{font-weight:800; font-size:1.25rem}
    .inv-meta{color:#6b7280; font-size:.95rem}
    .inv-table{width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:10px}
    .inv-table th,.inv-table td{padding:10px 12px; border:1px solid #e5e7eb; background:#fafafa}
    .inv-table td:first-child{border-radius:10px 0 0 10px}
    .inv-table td:last-child{border-radius:0 10px 10px 0}
    .inv-summary{display:flex; flex-direction:column; gap:6px; align-items:flex-end; margin-top:10px}
    .inv-summary .line{display:flex; gap:10px}
    .inv-summary .total{font-weight:800}

    @media print{
      body{background:#fff}
      header.top, .no-print{display:none !important}
      .invoice{box-shadow:none; border:none}
    }

    /* Toast */
    .toast-wrap{position:fixed; top:18px; right:18px; display:grid; gap:10px; z-index:50}
    .toast{background:#111827; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); opacity:0; transform:translateY(-10px); transition:.25s}
    .toast.show{opacity:1; transform:translateY(0)}
  </style>
</head>
<body>
  <header class="top no-print">
    <div class="container topbar">
      <div class="brand"><div class="logo" aria-hidden="true"></div> Chocomanía</div>
      <nav aria-label="principal">
        <ul>
          <li><a href="#catalogo">Catálogo</a></li>
          <li><a href="#carrito">Carrito</a></li>
          <li><a href="#pagos">Pagos</a></li>
        </ul>
      </nav>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn small" id="makeInvoice" type="button">Generar & Enviar boleta</button>
        <button class="btn primary" id="printLast" type="button">Imprimir / Guardar PDF</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Escenario 1: boleta generada y enviada -->
    <section class="section" aria-labelledby="esc1">
      <h2 id="esc1">Boleta generada y enviada</h2>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap" class="no-print">
        <label>Enviar a: <input id="emailTo" type="email" placeholder="andres@example.com" style="padding:8px 10px; border:1px solid #d1d5db; border-radius:10px"></label>
        <button class="btn" id="btnSend" type="button">Enviar</button>
      </div>
      <dialog id="sentDlg">
        <div class="modal" role="dialog" aria-labelledby="sentTitle" aria-describedby="sentDesc">
          <strong id="sentTitle">Boleta enviada</strong>
          <p id="sentDesc">Su boleta <code id="sentId">ORD-2025-045</code> ha sido enviada al correo.</p>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn" id="goMail" type="button">Ver correo</button>
            <button class="btn" id="closeSent" type="button">Aceptar</button>
          </div>
        </div>
      </dialog>
    </section>

    <!-- Escenario 2: ver el correo con la boleta adjunta -->
    <section class="section" aria-labelledby="esc2">
      <h2 id="esc2">Correo recibido (simulado)</h2>
      <div class="mail">
        <h3>Boleta Chocomanía</h3>
        <div class="attach">
          <div>Adjunto: <strong id="attachName">Boleta “ORD-2025-045”.pdf</strong></div>
          <div style="display:flex; gap:8px">
            <button class="btn small" id="previewBtn" type="button">Previsualizar</button>
            <button class="btn small" id="downloadBtn" type="button">Descargar</button>
          </div>
        </div>
        <div style="text-align:center;" class="no-print"><button class="btn" id="mailOk" type="button">Aceptar</button></div>
      </div>
    </section>

    <!-- Historial de compras con descarga -->
    <section class="section" aria-labelledby="esc3">
      <h2 id="esc3">Historial de compras — Boleta disponible</h2>
      <div id="history" class="list"></div>
    </section>

    <!-- Plantilla de boleta para impresión (se genera dinámicamente) -->
    <section class="section invoice" id="invoice" aria-label="Boleta (vista de impresión)"></section>
  </main>

  <div class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <footer class="container no-print" style="margin:18px auto 24px; color:var(--muted); text-align:center">
    © <span id="year"></span> Chocomanía · Boleta digital
  </footer>

  <script>
    // ===== Utilidades =====
    const $ = (s)=> document.querySelector(s);
    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.querySelector('.toast-wrap').appendChild(t); requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),200); }, 2400); }
    function currency(n){ return n.toLocaleString('es-CL', {style:'currency', currency:'CLP', maximumFractionDigits:0}); }

    // Datos demo (alineados con Partes 4–7)
    const PRODUCTS = {
      p21:{name:'Chocolate Dubai', price:5000},
      p02:{name:'Bombones surtidos', price:4500},
      p03:{name:'Trufa de cacao amargo', price:2500}
    };

    const LS_CART='choco_cart', LS_ORDERS='choco_orders', LS_SEQ='choco_order_seq';

    function nowISO(){ const d=new Date(); const pad=(n)=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
    function nextOrderId(){ const y=new Date().getFullYear(); let n=parseInt(localStorage.getItem(LS_SEQ)||'45',10)+1; localStorage.setItem(LS_SEQ, String(n)); return `ORD-${y}-${String(n).padStart(3,'0')}`; }

    function getCart(){ try{ return JSON.parse(localStorage.getItem(LS_CART))||{}; }catch{return{}} }

    function calcFromCart(cart){
      const items=[]; let subtotal=0;
      const ids = Object.keys(cart);
      if(ids.length===0){
        // Fallback al ejemplo de tu wireframe
        items.push({ id:'p21', name:PRODUCTS.p21.name, qty:1, price:PRODUCTS.p21.price, total:PRODUCTS.p21.price });
        items.push({ id:'p02', name:PRODUCTS.p02.name, qty:1, price:PRODUCTS.p02.price, total:PRODUCTS.p02.price });
      } else {
        ids.forEach(id=>{
          const p=PRODUCTS[id] || {name:'Producto', price:0};
          const qty=cart[id]; const total=p.price*qty; items.push({id, name:p.name, qty, price:p.price, total});
        });
      }
      subtotal = items.reduce((a,b)=>a+b.total,0);
      return {items, subtotal, shipping:0, discount:0};
    }

    function buildInvoiceHTML(order){
      const rows = order.items.map(it=>`<tr>
        <td>${it.name}</td><td style="text-align:center">${it.qty}</td><td style="text-align:right">${currency(it.price)}</td><td style="text-align:right">${currency(it.total)}</td>
      </tr>`).join('');
      const total = order.subtotal - (order.discount||0) + (order.shipping||0);
      return `
        <div class="inv-head">
          <div>
            <div class="inv-title">Boleta electrónica</div>
            <div class="inv-meta">Chocomanía · RUT 76.123.456-7</div>
            <div class="inv-meta">${order.date}</div>
          </div>
          <div style="text-align:right">
            <div class="inv-meta">Nº <strong>${order.id}</strong></div>
            <div class="inv-meta">Cliente: ${order.email}</div>
          </div>
        </div>
        <table class="inv-table" aria-label="Detalle de boleta">
          <thead><tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Total</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <div class="inv-summary">
          <div class="line"><span>Subtotal</span><strong>${currency(order.subtotal)}</strong></div>
          ${order.discount?`<div class="line"><span>Descuento</span><strong>−${currency(order.discount)}</strong></div>`:''}
          ${order.shipping?`<div class="line"><span>Envío</span><strong>${currency(order.shipping)}</strong></div>`:''}
          <div class="line total"><span>Total</span><strong>${currency(total)}</strong></div>
        </div>
        <p class="muted" style="margin-top:8px">Gracias por tu compra ♥ — Este documento es válido como comprobante.
        </p>`;
    }

    function openPrintWindow(html){
      const w=window.open('', '_blank');
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Boleta</title>
        <style>*{box-sizing:border-box}body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:18px}
        ${document.querySelector('style').innerHTML}
        </style></head><body><section class="invoice">${html}</section></body></html>`);
      w.document.close();
      w.focus();
      setTimeout(()=>{ try{ w.print(); }catch{} }, 250);
    }

    function saveOrder(order){
      const arr = JSON.parse(localStorage.getItem(LS_ORDERS)||'[]');
      arr.unshift(order); // más reciente primero
      localStorage.setItem(LS_ORDERS, JSON.stringify(arr));
      renderHistory();
    }

    function renderHistory(){
      const box = $('#history'); box.innerHTML='';
      const arr = JSON.parse(localStorage.getItem(LS_ORDERS)||'[]');
      if(arr.length===0){ box.innerHTML = '<div class="muted">Aún no hay boletas generadas.</div>'; return; }
      arr.forEach(o=>{
        const row = document.createElement('div'); row.className='rowItem';
        row.innerHTML = `<div>
          <div><strong>Pedido:</strong> ${o.id}</div>
          <div class="muted"><small>Cliente: ${o.email} · ${o.date}</small></div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn small" data-id="${o.id}" data-act="view">Ver</button>
          <button class="btn small" data-id="${o.id}" data-act="print">Descargar boleta PDF</button>
        </div>`;
        box.appendChild(row);
      });
      box.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-id'); const act=btn.getAttribute('data-act');
          const arr = JSON.parse(localStorage.getItem(LS_ORDERS)||'[]');
          const order = arr.find(x=>x.id===id);
          if(!order) return;
          const html = buildInvoiceHTML(order); $('#invoice').innerHTML = html; window.scrollTo({top: document.getElementById('invoice').offsetTop - 10, behavior:'smooth'});
          if(act==='print') openPrintWindow(html);
        });
      });
    }

    // Asegurar un pedido demo ORD-2025-045 como en tu wireframe
    (function ensureDemo(){
      const arr = JSON.parse(localStorage.getItem(LS_ORDERS)||'[]');
      if(!arr.find(x=>x.id==='ORD-2025-045')){
        const order = { id:'ORD-2025-045', date: nowISO(), email:'andres@example.com', ...calcFromCart({}), discount:0, shipping:0 };
        const html = buildInvoiceHTML(order); localStorage.setItem(LS_ORDERS, JSON.stringify([order, ...arr]));
        $('#invoice').innerHTML = html; // mostrar alguno por defecto
      } else {
        renderHistory();
      }
    })();

    // Botones principales
    document.getElementById('makeInvoice').addEventListener('click', ()=>{
      const cart = getCart(); const calc = calcFromCart(cart);
      const orderId = nextOrderId();
      const email = ($('#emailTo').value || 'andres@example.com').trim();
      const order = { id:orderId, date: nowISO(), email, ...calc };
      $('#invoice').innerHTML = buildInvoiceHTML(order);
      saveOrder(order);
      $('#attachName').textContent = `Adjunto: Boleta “${orderId}”.pdf`;
      $('#sentId').textContent = orderId;
      document.getElementById('sentDlg').showModal();
    });

    document.getElementById('btnSend').addEventListener('click', ()=>{
      document.getElementById('makeInvoice').click();
    });
    document.getElementById('closeSent').addEventListener('click', ()=> document.getElementById('sentDlg').close());
    document.getElementById('goMail').addEventListener('click', ()=>{ document.getElementById('sentDlg').close(); window.scrollTo({ top: document.getElementById('esc2').offsetTop - 10, behavior:'smooth'}); toast('Correo simulado abierto'); });

    // Correo: previsualizar / descargar (imprime)
    document.getElementById('previewBtn').addEventListener('click', ()=>{
      const arr = JSON.parse(localStorage.getItem(LS_ORDERS)||'[]'); const last=arr[0]; if(!last) return;
      const html = buildInvoiceHTML(last); $('#invoice').innerHTML = html; window.scrollTo({top: document.getElementById('invoice').offsetTop - 10, behavior:'smooth'});
    });
    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      const arr = JSON.parse(localStorage.getItem(LS_ORDERS)||'[]'); const last=arr[0]; if(!last) return; openPrintWindow(buildInvoiceHTML(last));
    });
    document.getElementById('mailOk').addEventListener('click', ()=> toast('¡Listo!'));

    // Botón fijo para imprimir la última
    document.getElementById('printLast').addEventListener('click', ()=>{
      const arr = JSON.parse(localStorage.getItem(LS_ORDERS)||'[]'); const last=arr[0]; if(!last){ toast('No hay boletas aún'); return; } openPrintWindow(buildInvoiceHTML(last));
    });

    // Pintar historial al cargar
    renderHistory();

    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
